大理大学本科毕业设计

基于深度学习的农作物叶片病害诊断服务系统

——面向PlantVillage数据集的双任务识别模型与Web一体化平台

DEEP LEARNING-BASED CROP LEAF DISEASE DIAGNOSIS 

AND SERVICE SYSTEM

——DUAL-TASK RECOGNITION MODEL FOR THE PLANTVILLAGE DATASET WITH A WEB-INTEGRATED PLATFORM

学      院：     数学与计算机学院                      

学生  姓名：      马童杰                                     

学      号：      20221108900213                                     

指导  教师：       杨邓奇                                    

专      业：       计算机科学与技术                                    

年级（班级）：   2022级2班                            

起止  日期：    2025年 6 月— 2025年 12 月            

# 摘  要

随着智慧农业和数字乡村建设的推进，传统依赖人工经验和农技人员巡查的植物病害诊断方式在时效性、专业性和覆盖范围等方面逐渐暴露出局限性。为提高病害诊断效率、降低使用门槛、提升服务覆盖，本课题设计并实现了一套基于深度学习的植物病害识别与辅助决策系统。系统以公开的 PlantVillage 植物病害图像数据集为基础，结合轻量级卷积神经网络 MobileNetV2、FastAPI 推理服务以及 Spring Boot 后端和 Vue3 前端，实现了“图像识别 + 知识服务 + 技术指导 + 在线交易”的一体化 Web 平台。

在模型层面，本文首先对 PlantVillage 数据集进行清洗、划分与增强，通过过滤异常图像和合理的训练/验证/测试集划分，保证数据质量和评估客观性。针对实际场景中存在大量纯背景和无效图片的问题，本文构建了叶片存在性二分类模型，将无叶片背景与含叶片图像区分开来，并在推理阶段采用两阶段识别框架：先由叶片存在性模型进行背景拦截与提示，再由基于 MobileNetV2 的物种识别模型和病害识别模型分别完成作物种类与病害类型的预测。训练过程中，引入了冻结策略、标签平滑、早停和学习率调度等优化手段，并通过独立的阈值校准过程对叶片存在性拦截策略进行调整，以在背景拦截和叶片保留之间取得平衡。

在系统层面，本文采用前后端分离与模型服务解耦的总体架构。前端基于 Vue3 + TypeScript + Element Plus 构建单页应用，实现了登录注册、病害识别、识别历史、病害知识库、技术指导、聊天消息、购物与订单、后台管理等功能；后端基于 Spring Boot 3 和 Spring Data JPA，负责用户与权限管理、识别记录管理、知识与技术指导管理、商品与订单管理、支付宝沙箱支付对接以及 WebSocket 消息推送等业务逻辑；模型推理服务基于 FastAPI 和 PyTorch 封装训练好的物种、病害和叶片存在性模型，对外提供统一的 /health 和 /predict 接口，并通过配置项与后端松耦合集成。数据库采用 MySQL，存储用户、识别记录、知识条目、技术指导文章、商品与订单等核心数据。

在测试与评估方面，本文从功能测试、识别模型评估和性能测试三个层面对系统进行验证。功能测试结果表明，系统能够支撑普通用户完成从图片上传、病害识别、知识查询、技术指导获取到农资购买和订单管理的完整业务流程，管理员可以在后台维护知识、指导、商品和订单信息；识别模型在 PlantVillage 测试集上取得了较为理想的分类性能，叶片存在性拦截策略在减少纯背景误诊方面发挥了积极作用；性能测试结果表明，在中等并发访问量下，识别接口和主要业务接口具有较为稳定的响应时间和资源占用。综合来看，本系统在功能完整性、识别准确性和系统可用性等方面基本达到了预期设计目标，为面向农户和种植户的植物病害智能诊断与辅助决策提供了一种可行方案。

关键词：植物病害识别；深度学习；MobileNetV2；FastAPI；Spring Boot；智慧农业

**Abstract**

With the rapid development of smart agriculture and digital countryside, traditional plant disease diagnosis methods that rely on farmers' experience and on-site inspection by agricultural technicians have gradually exposed limitations in timeliness, professionalism, and coverage. To improve diagnostic efficiency, lower the threshold for use, and expand service coverage, this thesis designs and implements a plant disease recognition and decision support system based on deep learning. Using the public PlantVillage dataset as the primary data source and combining the lightweight convolutional neural network MobileNetV2, a FastAPI-based inference service, a Spring Boot backend, and a Vue3 frontend, the system provides an integrated web platform that supports image-based disease recognition, knowledge services, technical guidance, and online transactions.

At the model level, the thesis first performs data cleaning, splitting, and augmentation on the PlantVillage dataset. By filtering abnormal images and adopting reasonable train/validation/test splits, data quality and evaluation objectivity are ensured. To address the large number of background or invalid images in real scenarios, a leaf presence binary classification model is constructed to distinguish background without leaves from leaf-containing images. A two-stage recognition framework is then adopted in inference: the leaf presence model first filters and warns about background images, and only images judged to contain leaves are further processed by MobileNetV2-based species and disease classifiers to predict crop species and disease types. During training, several optimization techniques are employed, including layer freezing strategies, label smoothing, early stopping, and learning rate scheduling. In addition, an independent threshold calibration procedure is used to adjust the leaf presence interception strategy so as to balance background filtering and retention of valid leaf images.

At the system level, a decoupled architecture with front–back separation and independent model services is adopted. The frontend is implemented as a Vue3 + TypeScript + Element Plus single-page application that provides functions such as user registration and login, disease recognition, history browsing, disease knowledge base, technical guidance, chat messages, shopping and orders, and admin console. The backend, built on Spring Boot 3 and Spring Data JPA, is responsible for user and role management, recognition record management, knowledge and guidance management, product and order management, Alipay sandbox payment integration, and WebSocket-based message pushing. The model inference service is implemented using FastAPI and PyTorch, encapsulating species, disease, and leaf presence models, and exposing unified /health and /predict endpoints which are loosely integrated with the backend via configuration. MySQL is used to store core data such as users, recognition records, knowledge entries, technical guidance articles, products, and orders.

In terms of testing and evaluation, the system is verified from three aspects: functional testing, recognition model evaluation, and performance testing. Functional tests show that the system can support normal users to complete the end-to-end workflow from image upload, disease recognition, knowledge query, and technical guidance acquisition to agro-product purchase and order management, while administrators can maintain knowledge, guidance, products, and orders in the admin console. On the PlantVillage test set, the recognition models achieve satisfactory classification performance, and the leaf presence interception strategy effectively reduces misdiagnosis on pure background images. Performance tests indicate that, under moderate concurrent access, the recognition endpoints and major business endpoints maintain relatively stable response times and reasonable resource usage. Overall, the system meets the expected design goals in terms of functional completeness, recognition accuracy, and usability, and provides a feasible solution for intelligent plant disease diagnosis and decision support for farmers and growers.

**Key Words：**Plant disease recognition; deep learning; MobileNetV2; FastAPI; Spring Boot; smart agriculture

# 目  录

[摘  要	I](#_Toc216213519)

[目  录	V](#_Toc216213520)

[第一章 绪论	- 1 -](#_Toc216213521)

[1.1 研究背景与意义	- 1 -](#_Toc216213522)

[1.1.1 研究背景	- 1 -](#_Toc216213523)

[1.1.2 国内外研究现状	- 1 -](#_Toc216213524)

[1.1.3 研究意义	- 2 -](#_Toc216213525)

[1.2 课题研究内容与目标	- 3 -](#_Toc216213526)

[1.2.1 研究内容	- 3 -](#_Toc216213527)

[1.2.2 研究目标	- 4 -](#_Toc216213528)

[1.3 研究方法与技术路线	- 5 -](#_Toc216213529)

[1.3.1 研究方法	- 5 -](#_Toc216213530)

[1.3.2 技术路线	- 5 -](#_Toc216213531)

[1.4 论文结构安排	- 6 -](#_Toc216213532)

[第二章 系统需求分析	- 7 -](#_Toc216213533)

[2.1 系统目标与定位	- 7 -](#_Toc216213534)

[2.3 功能需求分析	- 11 -](#_Toc216213535)

[2.3.1 植物病害识别子系统	- 12 -](#_Toc216213536)

[2.3.2 知识库与技术指导模块	- 12 -](#_Toc216213537)

[2.3.3 用户与权限管理模块	- 13 -](#_Toc216213538)

[2.3.4 购物与订单模块	- 13 -](#_Toc216213539)

[2.3.5 聊天/消息模块	- 14 -](#_Toc216213540)

[2.4 非功能需求分析	- 14 -](#_Toc216213541)

[2.4.1 性能需求	- 14 -](#_Toc216213542)

[2.4.2 可用性需求	- 14 -](#_Toc216213543)

[2.4.3 安全与可靠性需求	- 15 -](#_Toc216213544)

[2.5 用例分析与建模	- 15 -](#_Toc216213545)

[2.5.1 系统用例图	- 15 -](#_Toc216213546)

[2.5.2 典型用例描述表	- 16 -](#_Toc216213547)

[第三章 系统总体设计	- 19 -](#_Toc216213548)

[3.1 总体设计原则	- 19 -](#_Toc216213549)

[3.2 系统总体架构设计	- 20 -](#_Toc216213550)

[3.2.1 系统逻辑架构	- 20 -](#_Toc216213551)

[3.2.2 系统物理/部署架构	- 21 -](#_Toc216213552)

[3.3 功能模块划分	- 22 -](#_Toc216213553)

[3.3.1 前端模块设计（基于 Vue Router）	- 22 -](#_Toc216213554)

[3.3.2 后端业务模块设计（Spring Boot）	- 23 -](#_Toc216213555)

[3.3.3 识别模型服务模块设计（FastAPI）	- 24 -](#_Toc216213556)

[3.4 关键技术介绍	- 25 -](#_Toc216213557)

[3.4.1 前端关键技术	- 25 -](#_Toc216213558)

[3.4.2 后端关键技术	- 25 -](#_Toc216213559)

[3.4.3 识别模型与推理服务关键技术	- 26 -](#_Toc216213560)

[3.5 UML 设计	- 28 -](#_Toc216213561)

[3.5.1 系统包图	- 28 -](#_Toc216213562)

[3.5.2 核心类图	- 29 -](#_Toc216213563)

[3.5.3 典型时序图	- 30 -](#_Toc216213564)

[第四章 系统详细设计与实现	- 32 -](#_Toc216213565)

[4.1 数据集与数据预处理	- 33 -](#_Toc216213566)

[4.1.1 PlantVillage 数据集介绍	- 33 -](#_Toc216213567)

[4.1.2 数据清洗与质量过滤	- 33 -](#_Toc216213568)

[4.1.3 数据集划分策略	- 34 -](#_Toc216213569)

[4.1.4 数据增强策略	- 35 -](#_Toc216213570)

[4.2 识别模型总体设计	- 36 -](#_Toc216213571)

[4.2.1 任务定义与总体框架	- 36 -](#_Toc216213572)

[4.2.2 模型结构选择与对比	- 37 -](#_Toc216213573)

[4.3 模型结构与训练细节	- 37 -](#_Toc216213574)

[4.3.1 MobileNetV2 主干结构设计	- 37 -](#_Toc216213575)

[4.3.2 物种识别模型	- 38 -](#_Toc216213576)

[4.3.3 病害识别模型	- 38 -](#_Toc216213577)

[4.3.5 训练超参数与优化策略	- 40 -](#_Toc216213578)

[4.4 模型训练流程实现	- 41 -](#_Toc216213579)

[4.4.1 主训练脚本设计	- 41 -](#_Toc216213580)

[4.4.2 叶片存在性模型训练与校准	- 42 -](#_Toc216213581)

[4.4.3 模型保存与加载策略	- 43 -](#_Toc216213582)

[4.5 模型推理服务设计与实现	- 43 -](#_Toc216213583)

[4.5.1 FastAPI 推理服务结构	- 43 -](#_Toc216213584)

[4.5.2 /predict 接口实现	- 44 -](#_Toc216213585)

[4.5.3 与后端的集成	- 45 -](#_Toc216213586)

[4.6 业务系统详细实现	- 46 -](#_Toc216213587)

[4.6.1 前端实现	- 46 -](#_Toc216213588)

[4.6.2 后端实现	- 47 -](#_Toc216213589)

[第五章 系统测试与识别模型评估	- 48 -](#_Toc216213590)

[5.1 测试环境与工具	- 48 -](#_Toc216213591)

[5.1.1 硬件环境	- 49 -](#_Toc216213592)

[5.1.2 软件环境	- 49 -](#_Toc216213593)

[5.1.3 测试工具与辅助框架	- 49 -](#_Toc216213594)

[5.2 测试方法与测试策略	- 50 -](#_Toc216213595)

[5.2.1 黑盒测试与白盒测试	- 50 -](#_Toc216213596)

[5.2.2 单元测试、集成测试与系统测试	- 50 -](#_Toc216213597)

[5.3 功能测试	- 51 -](#_Toc216213598)

[5.3.1 功能模块测试用例设计	- 51 -](#_Toc216213599)

[5.3.2 测试用例表与执行结果记录	- 52 -](#_Toc216213600)

[5.4 识别模型测试与评估	- 52 -](#_Toc216213601)

[5.4.1 测试集选择与划分说明	- 52 -](#_Toc216213602)

[5.4.2 分类性能指标	- 53 -](#_Toc216213603)

[5.4.3 混淆矩阵与错误案例分析	- 53 -](#_Toc216213604)

[5.4.4 叶片存在性拦截策略评估	- 54 -](#_Toc216213605)

[5.5 性能测试	- 54 -](#_Toc216213606)

[5.5.1 并发访问下识别响应时间测试	- 55 -](#_Toc216213607)

[5.5.2 后端接口性能与数据库访问性能测试	- 55 -](#_Toc216213608)

[5.5.3 模型推理服务的吞吐量与资源占用分析	- 55 -](#_Toc216213609)

[5.6 测试结果分析与问题总结	- 56 -](#_Toc216213610)

[第六章 总结与展望	- 57 -](#_Toc216213611)

[6.1 工作总结	- 57 -](#_Toc216213612)

[6.2 创新点与特点	- 58 -](#_Toc216213613)

[6.3 存在的不足	                           	- 59 -](#_Toc216213614)

[6.4 后续工作展望	- 60 -](#_Toc216213615)

# 第一章 绪论

## 1.1 研究背景与意义

### 1.1.1 研究背景

农业是国民经济的基础，粮食安全和农产品质量直接关系到国家的经济发展和社会稳定。然而，在农业生产过程中，各类植物病害广泛存在并频繁发生，严重影响作物的产量和品质。一方面，病害会导致叶片黄化、斑点、枯萎等症状，进而降低光合作用效率、削弱植株抗逆性，甚至引起大面积减产或绝收；另一方面，部分病害还会影响农产品外观和内在品质，降低商品价值，给农户和相关产业链带来较大经济损失。

在传统农业生产模式下，病害诊断主要依赖农户的经验判断或农技人员的现场巡查。普通农户往往缺乏系统的植物病理学知识，只能凭借长期经验对病斑形态、颜色等进行主观判断，诊断结果容易受个人经验和环境因素影响，存在误诊和漏诊的风险。而专业农技人员数量有限，服务半径大，难以及时覆盖到广泛分布的农田，导致部分病害不能在早期被发现和处理。此外，人工巡查通常周期较长、效率较低，在大规模种植场景下难以满足精细化管理的需要。

随着新一代信息技术的迅猛发展，智慧农业、数字乡村、农业物联网等新理念不断涌现，大量传感器、无人机、智能手机等终端设备逐渐应用于农业生产一线。在这一背景下，如何利用计算机视觉和人工智能技术对作物病害进行自动识别和辅助诊断，成为农业信息化领域的重要研究方向。尤其是基于图像的病害识别方法，只需农户使用手机或相机拍摄作物叶片图片，即可在终端或云端完成自动分析，为农户提供直观、便捷的诊断建议，具有极高的应用潜力。 

### 1.1.2 国内外研究现状

早期的植物病害图像识别研究多基于传统机器学习方法，通常先通过颜色直方图、纹理特征、形状特征等手工特征对病斑区域进行描述，再利用支持向量机（SVM）、K 近邻（KNN）、决策树等分类算法完成病害识别。这类方法在小规模、特定场景下能够取得一定效果，但手工特征的表达能力有限，对光照、遮挡、拍摄角度等条件变化较为敏感，难以适应复杂多变的自然环境。

近年来，深度学习尤其是卷积神经网络（Convolutional Neural Network, CNN）的发展，为图像识别领域带来了显著突破。以 AlexNet、VGG、ResNet、DenseNet 等为代表的深层网络结构在大规模图像分类任务上取得了远超传统方法的性能。研究者开始将这类网络迁移到植物病害识别场景，通过在公共数据集或自建数据集上进行迁移学习和微调，大幅提升了病害识别的准确率和鲁棒性。一些工作利用 ResNet、Inception 等网络对多种作物和多种病害进行识别，在受控环境下可达到较高的分类精度。

在模型轻量化方面，国外学者提出了 MobileNet、ShuffleNet 等适用于移动端部署的网络结构，使得在资源受限设备（如手机、嵌入式终端）上进行实时推理成为可能。基于这些轻量级网络的植物病害识别系统，可以在本地或边缘设备上快速完成图像分类，降低对服务器带宽和计算资源的依赖。一些移动应用已将此类模型封装为农户可直接使用的诊断工具，支持拍照识别、病害信息查询和简单防治建议推送。

在国内，随着智慧农业和乡村振兴战略的推进，基于深度学习的病害识别研究也逐渐增多。许多研究团队围绕水稻、小麦、玉米、果树等主要作物构建图像数据集，探索利用卷积神经网络进行病害自动识别，并在此基础上开发原型系统或 Web/移动应用平台。一些系统还结合农业专家知识库，为农户提供针对性的防治方案和用药建议。但总体而言，现有系统在模型泛化能力、数据集多样性、与实际业务流程的深度融合等方面仍存在不足，尤其是在将识别结果与农资推荐、技术指导、在线咨询等服务整合方面，仍有较大提升空间。 

### 1.1.3 研究意义

从应用层面来看，构建一个面向农户和种植户的植物病害识别与辅助决策系统，可以极大降低病害诊断的专业门槛。农户只需使用手机或电脑上传作物叶片图片，即可在较短时间内获得自动诊断结果和参考建议，避免完全依赖经验判断。同时，通过系统记录历史识别结果并与知识库联动，农户可以回溯不同时间、不同地块的病害发生情况，为制定施肥、防治和轮作计划提供数据支持。

从技术层面来看，基于 PlantVillage 等公开数据集构建深度学习模型，并结合轻量级网络结构与两阶段识别框架（叶片存在性判别与病害分类），有助于探索适用于农业场景的高效、鲁棒的模型设计方法。本系统在模型层面采用 MobileNetV2 作为主干网络，引入叶片存在性二分类模型对纯背景或无效图片进行筛除，再针对物种和病害分别训练分类模型，并通过 FastAPI 部署为独立推理服务，提升了整体性能与可扩展性。

从系统层面来看，将病害识别、知识服务、技术指导、在线交流和农资购物等功能集成在同一 Web 平台，有助于形成“诊断—学习—决策—服务”的业务闭环。一方面，系统能够为农户提供从病害识别到防治建议再到农资购买的全流程支持；另一方面，专家和管理员可以通过后台管理知识库、技术指导文章和商品信息，结合识别记录开展数据分析和服务优化。这种一体化设计有利于提升农业信息服务的覆盖面和精准度，对推动智慧农业和数字乡村建设具有一定的现实意义和推广价值。 

## 1.2 课题研究内容与目标

### 1.2.1 研究内容

本课题围绕“植物病害识别与辅助决策系统”的构建展开，结合深度学习模型与 Web 应用开发，主要研究内容包括以下几个方面：

首先，开展需求调研与系统整体方案设计。通过查阅相关文献和分析典型系统，总结植物病害诊断的关键业务流程，明确系统的目标用户、使用场景和功能需求。在此基础上，采用用例分析等方法，提炼系统的核心功能模块，并给出整体架构设计和技术选型方案。

其次，构建植物病害识别模型。基于 PlantVillage 数据集，对各类作物及其病害图像进行整理和预处理，按照训练集、验证集和测试集进行科学划分，避免数据泄漏和评估偏差。选择 MobileNetV2 作为基础网络结构，分别针对“物种识别”和“病害识别”两个任务进行迁移学习与微调，并设计叶片存在性二分类模型，对无叶片背景图像加以拦截，形成两阶段识别框架。通过合理设置训练超参数、数据增强策略和优化方法，不断提升模型的分类准确率和泛化能力。

第三，设计与实现前端 Web 系统。前端采用 Vue3 + TypeScript 以及 Element Plus 组件库构建单页应用（SPA），围绕“识别、历史、知识库、技术指导、聊天室、购物”等业务需求，设计首页、病害识别页面、识别历史页面、病害知识与技术指导列表及详情页面、消息交流页面、购物车与订单页面、用户中心等模块，并通过路由和导航守卫控制访问权限和角色差异。

第四，设计与实现后端业务系统。后端基于 Spring Boot 3 框架，结合 Spring MVC 和 Spring Data JPA，实现用户管理、识别记录管理、知识与技术指导管理、商品与订单管理等业务逻辑，使用 MySQL 作为关系型数据库存储系统数据。集成支付宝沙箱支付，实现从提交订单到支付回调和订单状态更新的完整流程，并通过 WebSocket 为聊天和通知功能提供实时通信能力。

第五，设计 FastAPI 推理服务并与 Spring Boot 系统集成。在 Python 端使用 FastAPI 框架封装训练好的物种和病害识别模型以及叶片存在性模型，提供统一的健康检查和图像预测接口。后端通过配置化的方式调用 FastAPI 服务，实现图像上传、转发、结果解析与存储，并向前端提供统一的 REST API 接口。

第六，开展系统测试与效果评估。通过功能测试、性能测试和模型评估，对前后端系统以及推理服务进行全面验证。从准确率、响应时间、并发能力和用户体验等方面分析系统的性能表现，总结存在的问题并提出改进建议。 

### 1.2.2 研究目标

围绕上述研究内容，本课题拟实现以下具体目标：

第一，构建一个能够面向普通农户和种植户的植物病害自动识别功能。系统应支持用户上传作物叶片图像，自动返回物种名称、病害类型以及相应置信度信息，并在识别结果页面给出直观、易懂的展示方式。

第二，构建多角色协同的知识服务与技术指导平台。系统需要支持普通用户、专家用户和管理员等不同角色，实现知识库浏览、技术指导文章发布与维护、在线消息交流等功能。通过角色权限控制，保障系统的安全性和管理有序性。

第三，完成从图片上传、识别诊断、知识查询、技术指导到农资购买、订单管理和历史追溯的闭环业务流程。系统应能够记录每一次识别请求及其结果，支持用户查看历史记录和对应的诊断信息，并与知识库、技术指导和购物模块进行联动，提升系统的综合服务能力。

 

第四，在性能和体验方面，确保系统在合理的硬件条件下具备较好的响应速度和并发处理能力。面对日常使用场景，病害识别服务应在可接受的时间内返回结果，系统界面交互应保持流畅，整体易用性良好。同时，通过科学的模型设计和参数设置，使识别准确率达到预期指标，为后续推广应用奠定基础。  

## 1.3 研究方法与技术路线

### 1.3.1 研究方法

为实现上述目标，本文综合采用多种研究方法，主要包括：

（1）文献调研与对比分析。通过查阅国内外相关研究文献和公开系统案例，了解植物病害识别领域的发展脉络、主流方法和典型应用，总结现有工作的优点和不足，为本系统的功能设计和模型选择提供参考依据。

（2）需求分析与用例驱动设计。通过对目标用户和典型使用场景的分析，采用用例图和用例描述等方法，系统化地整理功能需求和非功能需求。在此基础上进行系统分层和模块划分，保证系统结构清晰、职责明确。

（3）基于深度学习的实验与模型优化。利用 PyTorch 深度学习框架，在 PlantVillage 数据集上开展多轮实验，对网络结构、学习率、批大小、数据增强策略、冻结策略等超参数进行对比和调优。通过交叉验证和测试集评估，选择在准确率和效率上较为均衡的模型方案。

（4）基于原型的前后端迭代开发。采用前后端分离的开发模式，前端使用 Vue3 + TypeScript 构建单页应用，后端使用 Spring Boot 提供 REST API 和 WebSocket 服务，模型服务则由 FastAPI 提供统一接口。在开发过程中采用迭代式优化，根据测试反馈不断完善交互设计和系统性能。

（5）系统测试与综合评估。通过设计系统级和模块级的测试用例，对关键功能和重要业务流程进行全面测试，并对模型识别效果进行定量评估。综合分析测试结果，归纳系统的优势与不足，为后续优化和扩展提供依据。 

### 1.3.2 技术路线

本课题的技术路线可以概括为“数据与模型构建—推理服务封装—业务系统集成—前端交互实现”四个层次，具体包括：

在数据与模型层面，首先基于 PlantVillage 数据集对原始图像数据进行整理和清洗，按一定比例划分训练集、验证集和测试集，并根据任务需求生成物种和病害的类别名称列表。随后，利用 PyTorch 和 TorchVision，选取 MobileNetV2 作为基础网络结构，分别训练物种识别模型和病害识别模型，同时构建叶片存在性二分类模型，用于对无效背景图片进行预筛选，形成两阶段识别框架。

在推理服务层面，将训练好的模型通过 FastAPI 封装为独立的 Web 服务，提供健康检查接口和图像预测接口。在该服务中实现统一的图像预处理流程、模型加载策略和结果格式化逻辑，并通过配置文件管理模型权重路径、运行设备（CPU/GPU）等参数，保证服务的稳定性和可维护性。

在业务系统层面，采用 Spring Boot 构建后端应用，集成 Spring MVC、Spring Data JPA 等组件，设计和实现用户管理、识别记录管理、知识和技术指导管理、购物和订单管理等业务模块。后端通过配置化方式访问 FastAPI 推理服务，完成从前端上传图片到模型识别再到结果入库的完整数据流转，同时集成支付宝沙箱支付接口和 WebSocket 通道，为订单支付和消息推送提供支撑。

在前端交互层面，使用 Vue3 + TypeScript 与 Element Plus 构建单页应用，设计首页、识别页面、历史记录、知识库、技术指导、用户中心、购物和订单等界面，并通过 Vue Router 和导航守卫实现路由管理和权限控制。前端通过统一封装的 API 模块与后端进行数据交互，为不同角色的用户提供直观、友好的操作界面。

总体而言，本课题在技术路线中实现了数据—模型—服务—应用的有机结合，为后续章节的详细设计和实现奠定基础。 

## 1.4 论文结构安排

本文在整体结构上按照“提出问题—分析需求—设计方案—实现系统—测试评价—总结展望”的思路进行安排，各章节内容如下：

第1章为绪论，主要介绍课题的研究背景与意义，综述国内外相关研究现状，明确本课题的研究内容与目标，阐述所采用的研究方法和技术路线，并对论文的整体结构进行说明。

第2章为系统需求分析，重点从系统建设目标、目标用户和业务场景出发，分析系统的功能需求和非功能需求，给出用户角色划分和典型业务用例，并通过用例图和用例描述表的形式对系统需求进行形式化表达，为后续设计提供依据。

第3章为系统总体设计，从总体架构、功能模块划分和关键技术三个层面，对系统的整体方案进行设计说明。通过逻辑架构和部署架构图展示前端、后端、模型服务和数据库之间的关系，结合 UML 包图、类图和时序图说明核心模块的内部结构和交互流程。

第4章为系统详细设计与实现，重点介绍植物病害识别模型的设计与训练过程，包括数据集划分、数据预处理与增强、MobileNetV2 模型结构与两阶段识别框架等内容；同时详细说明前端各业务模块、后端业务逻辑、数据库表结构以及支付和消息模块的具体实现方式。

第5章为系统测试，从功能测试、性能测试和模型评估等方面，对系统的正确性、稳定性和实用性进行验证。通过设计测试用例和统计测试结果，分析系统在实际运行中的表现，总结存在的问题和不足。

第6章为总结与展望，对本课题的研究工作和主要成果进行归纳，总结系统在植物病害识别与辅助决策方面的实际效果，并结合当前技术发展趋势，展望未来在数据扩展、模型优化、系统功能拓展等方面的改进方向。

# 第二章 系统需求分析

## 2.1 需求获取

### 2.1.1 业务需求

随着智慧农业和数字乡村建设的推进，面向一线农户和种植户的植物病害智能诊断与辅助决策系统需求日益凸显。通过对实际生产场景的调研和分析，结合项目代码实现，本系统定位为集“诊断、知识服务、技术指导、交易”于一体的综合性 Web 平台。

### 2.1.2 功能需求

基于项目的实际代码结构和前后端实现，系统功能主要包括以下几个核心模块：

（1）植物病害识别子系统

图片上传与基本校验：支持用户从本地相册或相机选择叶片图片上传，进行文件类型和大小校验，并安全保存到服务器 uploads 目录

识别请求与结果展示：通过 FastAPI 推理服务进行叶片存在性判别和物种/病害双模型识别，返回包含物种名称、病害名称、置信度及 Top-K 候选列表的识别结果

历史记录管理与统计：存储用户的识别记录，支持按时间倒序分页浏览和关键字模糊查询，并提供按月份、病害类型聚合的统计数据接口

识别报告生成：基于单条识别记录按需生成 PDF 报告，报告中包含病害概述、防治建议和推荐用药等信息

（2）知识库与技术指导模块

病害知识信息管理：以病害分布信息表 bhxx 为核心数据源，按作物和病害名称维护分布区域、发生时间、防治方法等条目

防治物品信息管理：维护与病害对应的防治物品（农资）信息，包含适用作物、针对病害、价格、图片等字段，支持分页和关键字检索

技术指导文章发布：农林专家发布和维护防治方案、栽培管理建议等图文文章，普通用户可在前端按关键字或时间顺序浏览

文章互动与收藏：支持对技术指导文章进行评论、回复及收藏，形成用户个人知识清单

识别结果联动：识别结果与相关知识条目、技术指导文章和推荐防治物品关联，实现从识别详情一键跳转

（3）用户与权限管理模块

用户注册/登录/注销：基于账号密码的用户认证系统，统一通过拦截器保护业务接口

用户信息维护：支持修改昵称、手机号、收货地址等个人资料，并提供头像上传功能

密码管理：提供基于旧密码校验的新密码修改流程，提升账号安全性

角色与用户类型控制：通过 role 和 userType 区分普通用户、农户、农林专家和系统管理员，在后台接口层面实现权限控制

（4）购物与订单模块

商品展示与详情：农资商品的分类、名称、图片、价格、适用作物和病害等信息

购物车与收藏管理：支持将商品加入购物车、修改数量、删除记录，并可对感兴趣的商品加入/取消收藏

订单与支付流程：支持“立即购买”和“购物车结算”两种下单方式，集成支付宝沙箱支付接口，完成订单创建、支付请求、回调验签和状态更新（CREATED/PAID/COMPLETED）

订单查询与后台管理：普通用户可查看个人订单列表和详情，管理员可在后台查看全站订单并对已支付订单执行确认收货

（5）聊天/消息与好友模块

好友关系管理：支持按账号或手机号搜索并添加好友，为互为好友的用户自动创建私聊会话

消息交互：基于聊天室模型实现用户之间的文本消息收发，并按会话分页返回历史消息

实时消息推送与消息管理：通过 WebSocket 技术实现消息的实时传输，同时支持消息撤回、删除等状态同步

（6）公告与病害预警模块

系统公告发布与浏览：管理员在后台维护已发布公告，前端按时间倒序展示公告列表和详情

病害预警服务：结合病害分布区域、发生时间和天气关键信息，为指定地区和月份生成高风险病害提示列表

### 2.1.3 典型业务场景

结合项目实际代码实现，系统主要包含以下典型业务场景：

（1）上传作物叶片图片进行病害识别：用户登录系统后，在识别页面上传叶片图片，后端将图片转发至 FastAPI 推理服务处理，返回识别结果并展示

（2）浏览病害知识库与技术指导文章：用户在知识库和技术指导页面浏览分类内容，可通过搜索或筛选查找特定信息

（3）通过消息模块与专家沟通：用户在消息页面与专家进行咨询，接收系统通知

（4）在线购买农资商品：用户浏览商品，将合适的商品加入购物车，提交订单并通过支付宝沙箱完成支付

（5）管理员维护系统内容：管理员登录后台管理界面，维护病害知识、技术指导内容、商品信息和订单数据

## 2.2 非功能性需求

### 2.2.1 性能需求

（1）识别响应时间：在普通网络环境和常规服务器配置下，单次识别请求的响应时间控制在可接受范围内 （2）并发访问支持：通过合理的线程池配置、连接池管理和模型加载优化，保障一定并发量下的系统稳定性 （3）资源隔离：训练脚本与在线推理服务做好资源隔离，避免训练任务影响在线识别服务的稳定性

### 2.2.2 可用性需求

（1）界面友好性：针对农户等非专业用户群体，提供简洁直观的界面设计和清晰的操作指引 （2）浏览器兼容性：系统前端基于 Vue3 实现，支持最新版 Chrome、Edge 等现代浏览器

### 2.2.3 安全与可靠性需求

（1）用户认证与授权：实施基于角色的访问控制（RBAC），通过登录拦截器与管理员拦截器统一保护 /api/** 接口，防止未授权访问 （2）支付安全：确保支付宝沙箱支付请求参数、签名和回调处理逻辑的正确性，对回调结果进行验签，保证订单数据一致性 （3）模型服务健康检查：后端通过 /api/detect/health 接口主动检查 FastAPI 推理服务状态，前端定时轮询展示“模型服务在线/离线”状态，便于运维排查 （4）异常处理与日志：当 FastAPI 推理服务不可用或返回异常时，后端记录详细错误日志，并向前端返回友好的错误提示，同时保证 Spring Boot 自身接口仍然可用

## 2.3 标识参与者

根据项目代码中的用户角色设计和权限配置，系统的主要参与者包括：

### 2.3.1 普通用户（农户）

系统的核心服务对象，通过 Web 前端访问系统。主要权限包括：

账号注册、登录与个人资料修改

上传叶片图片进行病害识别

查看识别历史记录

浏览病害知识库和技术指导文章

与专家或系统进行消息交流

浏览、购买农资商品

### 2.3.2 专家用户

承担专业知识供给和技术服务的角色，主要权限包括：

发布和维护病害知识条目和技术指导文章

回复普通用户的咨询

参与系统内容的审核和修订

### 2.3.3 系统管理员

负责系统的日常运行和维护，主要权限包括：

用户账户与角色管理

病害知识与技术指导内容维护

商品与订单管理

支付配置管理

系统监控与日志查看

## 2.4 标识用例

基于项目的实际功能实现和参与者需求，系统的主要用例包括：

### 2.4.1 普通用户用例

注册账号

登录系统

修改个人信息与头像

上传叶片图片进行病害识别

查看识别结果及防治建议

查看识别历史记录与统计概览

对识别结果提交纠错反馈

浏览病害知识

浏览技术指导文章并发表评论、回复和收藏

查看疾病预警信息

查看系统公告

添加好友并发起私聊

浏览商品

将商品加入购物车或收藏

提交订单

完成支付

查看订单列表与订单详情

### 2.4.2 专家用户用例

登录系统

发布和维护技术指导文章

维护病害知识条目

查看识别记录辅助诊断

查看并处理识别纠错反馈（确认无误或给出正确的植物和病害名称）

通过聊天模块与普通用户、农户进行在线交流

### 2.4.3 管理员用例

管理用户和角色

维护病害知识和技术指导内容

维护商品信息

查看和管理订单

配置支付参数和模型服务地址

发布和维护系统公告

监控模型服务和系统运行状态

## 2.5 求精用例

### 2.5.1 用例一：用户注册与登录

参与者：普通用户

前置条件：用户可正常访问系统登录/注册页面，系统运行状态稳定。

主事件流： 1）用户在注册页面填写符合格式要求的用户名、密码及个人基本信息，提交注册请求； 2）系统对用户名唯一性和字段格式进行校验，通过后在用户表中创建新的账户记录； 3）用户在登录页面输入用户名和密码，提交登录请求； 4）系统校验用户名是否存在、密码是否匹配，验证通过后创建会话，并在服务端记录登录状态； 5）前端根据登录状态更新本地存储信息，并将用户导航至首页或上次访问页面，展示相应功能入口。

备用事件流： 1）当用户名已存在或注册信息格式不符合要求时，系统返回明确的错误提示，用户根据提示修改后重新提交注册请求； 2）当登录阶段用户名不存在或密码错误时，系统返回登录失败信息，不建立会话，用户可重新输入凭证或找回密码； 3）当系统发生不可预期错误时，记录错误日志，并向用户返回通用的失败提示信息。

### **2.5.2 **用例二：上传植物叶片图片进行病害识别

参与者：普通用户

前置条件：用户已成功登录系统并进入识别页面；Spring Boot 后端与 FastAPI 模型服务均处于可用状态。

主事件流： 1）用户在识别页面选择本地叶片图片或通过终端设备拍照，并在界面中确认上传操作； 2）前端对待上传文件的类型和大小进行初步校验，通过后将图片文件随表单一并提交至后端识别接口； 3）后端在服务器本地创建唯一文件名，将图片保存到 uploads 目录，并构造请求调用 FastAPI 推理服务的预测接口； 4）FastAPI 完成叶片存在性判别及物种/病害双模型推理，返回包含物种名称、病害名称、置信度及 Top-K 候选列表的结构化结果； 5）后端解析推理结果，关联相应病害知识与防治物品信息，将识别结果、图片路径及防治建议等写入数据库； 6）前端接收并展示识别结果，同时提供跳转入口至病害知识详情、技术指导文章及推荐农资商品页面。

备用事件流： 1）若上传文件类型或大小不满足前端校验规则，则前端在本地阻止请求并给出提示；若前端未拦截但后端发现文件无效，则返回“文件格式不支持”等错误信息； 2）若调用 FastAPI 模型服务超时或返回异常，后端捕获异常并记录日志，同时向前端返回友好的错误提示，建议用户稍后重试或联系管理员； 3）若识别结果持久化至数据库过程中发生错误，系统记录详细错误信息，并提示用户识别结果暂未保存，以避免误导性呈现； 4）当模型判定图像为“背景无叶片”或疑似背景时，后端返回相应标记，前端引导用户重新拍摄更清晰的叶片图片。

### 2.5.3 用例三：查看识别历史记录

参与者：普通用户

前置条件：用户已登录系统，并至少完成过一次病害识别操作。

主事件流： 1）用户在系统导航菜单中选择“历史记录”功能入口； 2）前端根据当前登录用户身份，向后端请求该用户的识别记录列表，可携带分页参数和关键字查询条件； 3）后端按照识别时间倒序查询识别结果，封装成分页数据结构返回，包括预测类别、置信度、防治建议、识别时间及缩略图等； 4）前端以列表或卡片形式呈现历史记录，用户可点击某条记录查看识别详情； 5）在识别详情页面，用户可进一步跳转至相关病害知识、技术指导文章或生成识别报告等功能。

备用事件流： 1）当用户尚未进行过任何识别操作时，后端返回空列表，前端在历史记录页面显示“暂无识别记录”等提示信息； 2）当分页参数非法或查询条件异常时，后端采用合理默认值进行处理，并返回规范化的分页结果； 3）当用户请求删除单条或多条历史记录时，后端在校验记录归属后执行删除，同时清理关联纠错反馈，前端根据返回结果刷新列表。

### 2.5.4 用例四：提交商品订单并完成支付

参与者：普通用户

前置条件：用户已登录系统，购物车中存在至少一条待购买的农资商品记录，且支付宝沙箱支付环境配置正确。

主事件流： 1）用户在购物车页面核对商品名称、数量和单价，选择需要结算的条目，点击“结算”按钮； 2）前端将选中的购物车条目 ID 列表、数量等信息提交至后端订单结算接口； 3）后端校验购物车条目归属与有效性，计算各商品行小计和订单总金额，创建订单主表及订单明细记录，并标记订单状态为 CREATED； 4）用户在订单详情或支付页面点击“去支付”，前端调用后端支付接口，请求生成支付宝 PC 网页支付表单； 5）后端根据订单信息构造支付宝请求参数并发起跳转，用户在支付宝沙箱页面完成支付操作； 6）支付宝通过同步返回和异步回调接口通知系统支付结果，后端在验签通过后将订单状态更新为 PAID，前端在用户返回系统后展示支付结果和最新订单状态； 7）用户在收货后，可在订单详情页面发起“确认收货”操作，系统将订单状态更新为 COMPLETED。

备用事件流： 1）若购物车中不存在有效商品或计算得到的订单总金额小于等于零，后端返回错误信息，前端提示用户检查购物车内容； 2）支付过程中若用户主动取消支付或支付失败，订单状态保持为“未支付”，系统在订单列表中突出显示，用户可后续重新发起支付或取消订单； 3）在支付宝回调阶段，如验签失败或回调参数异常，系统拒绝更新订单状态，记录详细日志并提示管理员排查； 4）网络故障或第三方服务异常导致支付结果暂时不可确认时，系统在后续回调或人工干预后进行状态修正，并确保不会重复记账。

### 2.5.5 用例五：管理员维护系统内容

参与者：系统管理员

前置条件：管理员已通过后台登录认证，具备相应模块的管理权限。

主事件流： 1）管理员在后台管理界面中选择目标模块（如知识管理、技术指导管理、公告管理、商品管理、订单管理等）； 2）系统按指定筛选条件和分页参数从数据库中加载相应数据列表，并在界面中呈现； 3）管理员根据业务需求，对选定条目执行新增、编辑或删除操作，系统对关键字段进行合法性校验后持久化至数据库； 4）在订单管理模块中，管理员可查看订单详情、支付状态及物流信息，对异常订单进行标记和处理； 5）在系统设置模块中，管理员可配置或更新支付参数、模型服务访问地址等关键运行参数，并保存生效。

备用事件流： 1）当管理员权限不足以访问某一模块或执行某项操作时，系统拒绝请求并返回“权限不足”等提示信息； 2）当数据校验失败（如价格为负数、必填字段为空）时，系统阻止提交并在界面中标出错误字段； 3）当数据库或外部依赖暂时不可用时，系统记录错误日志并向管理员返回友好提示，避免造成数据不一致。

### 2.5.6 用例六：识别纠错与专家审核

参与者：普通用户、农林专家

前置条件：普通用户已登录系统，并在历史记录中存在至少一条识别结果；系统中已存在至少一名启用状态且用户类型为“专家”的账号。

主事件流： 1）普通用户在识别历史详情页发现模型识别结果可能有误，点击“识别有误/提交纠错”入口； 2）用户在弹出界面中选择目标专家，填写纠错说明（如实际观察到的症状及可能的病害），并提交反馈； 3）后端校验识别记录是否属于当前用户、专家账号是否存在且处于启用状态，校验通过后为该识别结果创建一条纠错反馈记录，初始状态为“待专家处理”； 4）专家登录系统，在“纠错任务”或“我的任务”页面按状态查看待处理反馈列表，选中某条记录进入详情； 5）专家综合查看原始识别结果、病害知识和用户提供的说明后，给出专业判断：

若确认模型识别结果正确，则填写补充说明并将反馈状态更新为“确认无误”；

若确认模型识别结果错误，则填写正确的植物名称和病害名称，系统基于映射关系生成新的模型类别标记，并将状态更新为“确认有误”，同时标记需要补充数据集与后续重训。 6）普通用户在“我的纠错反馈”列表中查看各条反馈的最新处理状态和专家回复内容。

备用事件流： 1）当识别记录不存在或不属于当前用户时，后端拒绝创建反馈并返回错误提示； 2）当所选专家账号不存在、未启用或其用户类型不是“专家”时，系统中止流程并提示用户重新选择专家； 3）对于已进入终态（如“确认无误”或“确认有误”）的反馈记录，系统禁止重复确认或修改，仅允许查看历史处理记录； 4）在记录映射模型类别时如无法根据植物名称和病害名称找到合法组合，系统提示专家调整填写内容或联系维护人员补充映射规则。

### 2.5.7 用例七：添加好友并发起聊天

参与者：普通用户

前置条件：发起方与目标用户均已在系统中完成注册并处于启用状态；即时通信与 WebSocket 服务运行正常。

主事件流： 1）用户在“添加好友”界面输入目标用户的账号或手机号，提交好友添加请求； 2）后端根据输入信息在用户表中查找目标用户，并校验目标用户存在且非当前登录用户； 3）若双方尚未建立好友关系，系统在好友关系表中创建一条新的双向好友记录；若已是好友，则跳过创建步骤； 4）系统调用聊天服务，为双方创建或复用一间私聊聊天室，并返回聊天室标识和对方用户的概要信息； 5）前端根据返回的聊天室标识跳转至聊天界面，请求该聊天室最近一段时间的消息列表，并按时间顺序展示； 6）用户在聊天输入框中编辑并发送文本消息，前端通过 REST 接口将消息内容和聊天室标识提交后端； 7）后端校验发送者是否为该聊天室成员，校验通过后持久化消息记录，并通过 WebSocket 将新消息实时推送给聊天室内的其他在线成员。

备用事件流： 1）当目标用户不存在、被禁用或输入信息为当前登录用户自身时，系统拒绝创建好友关系并给出相应提示； 2）在创建好友关系或聊天室过程中发生数据库异常时，系统中止操作并记录错误日志，对外仅返回通用失败信息； 3）当用户尝试在未加入的聊天室中发送、撤回或删除消息时，后端根据成员校验结果拒绝请求，并返回权限不足的提示； 4）当 WebSocket 连接异常或网络不稳定导致实时推送失败时，系统确保消息已持久化，前端在下一次拉取历史记录时仍可获取完整消息内容。

# 第三章 系统总体设计

## 3.1 总体设计原则

在第1章和第2章中分别对课题背景、研究意义以及系统需求进行了分析。基于已明确的业务目标和功能需求，本章从总体设计层面对系统的架构和关键技术进行说明。在总体设计过程中，主要遵循以下原则：

（1）结构清晰、分层合理、可扩展性强。系统在架构上采用分层与模块化设计思想，将表示层、业务逻辑层、模型服务层和数据访问层进行合理分离。前端采用单页应用（SPA）模式，后端采用典型的 Controller–Service–Repository 分层结构，模型服务则以独立进程方式提供推理接口。通过清晰的分层与模块边界设计，提高系统的可阅读性和可维护性，便于后续功能扩展和性能优化。

（2）前后端分离与微服务化思路。系统在实现上采用前后端分离的架构：前端基于 Vue3 + TypeScript 构建 SPA，后端基于 Spring Boot 提供 RESTful API 和 WebSocket 服务，前端与后端通过 HTTP/HTTPS 接口进行数据交互；识别模型服务则通过 FastAPI 作为独立进程运行，与后端之间通过 HTTP 接口解耦交互。这种设计具备一定的微服务化特征，为后续将推理服务独立部署、水平扩展或迁移到云端提供了基础。

（3）模型服务与业务服务解耦。植物病害识别模型的训练与推理均在 Python 环境中完成，而业务系统主要运行在 Java/Spring Boot 环境中。为避免在同一进程中混合运行两种技术栈，系统采用“后端业务服务 + 独立推理服务”的模式，后端只负责转发图片和解析结果，不直接依赖具体的模型实现细节。两者之间通过配置项 ml.fastapi.url 进行解耦，既便于模型的独立更新与升级，也便于在需要时更换或增加模型类型。

综上所述，本系统在总体设计上力求保证结构合理、职责清晰，在满足现有业务需求的基础上兼顾后续的维护和扩展需要。

## 3.2 系统总体架构设计

### 3.2.1 系统逻辑架构

从逻辑层面来看，本系统可以划分为前端表示层、后端业务逻辑层、识别模型服务层和数据持久化层等几个部分，各子系统之间的关系如下：

（1）前端表示层。前端位于 bysj-mtj-web 子项目中，通过 Vue3 单页应用向用户呈现界面，包括首页、识别页面、历史记录页面、知识库与技术指导页面、消息页面、购物车与订单页面以及后台管理页面等。前端通过封装好的 API 请求工具与后端业务接口交互，通过路由和导航守卫控制页面访问权限和角色差异。

（2）后端业务逻辑层。后端位于 springboot 子项目中，采用 Spring Boot 3 框架实现。该层对外提供 RESTful API 和 WebSocket 服务，对内组织用户管理、识别记录管理、知识与技术指导管理、购物与订单管理、支付集成、消息推送等业务逻辑。对于植物病害识别的请求，后端负责接收前端上传的图片、调用 FastAPI 推理服务并解析返回结果，然后将结果持久化到数据库并返回给前端。

（3）识别模型服务层。识别模型服务位于 pymodel 子项目中，采用 FastAPI 框架封装训练好的叶片存在性模型、物种识别模型和病害识别模型，对外提供 /health 和 /predict 等接口。/health 接口用于返回模型加载状态、类别数量和运行设备等信息，/predict 接口接收上传图片文件，执行两阶段推理并返回结构化的识别结果。业务后端通过 HTTP 调用该服务，实现与模型的解耦。

（4）数据持久化层。系统使用 MySQL 作为关系型数据库，存储用户信息、识别记录、知识与技术指导内容、商品和订单等业务数据。Spring Data JPA 提供了实体与数据库表之间的映射以及常用 CRUD 操作。除此之外，系统还通过本地文件系统存储用户上传的图片资源以及部分静态文件，Spring Boot 通过静态资源配置将 uploads/ 目录映射为可访问路径。

从数据流的角度看，用户的浏览器通过前端发送请求，后端根据请求类型访问数据库或调用 FastAPI 模型服务，并将获得的结果通过 JSON 形式返回前端，前端再结合 Element Plus 等组件进行友好展示，形成一个完整的闭环。

### 3.2.2 系统物理/部署架构

在物理部署层面，系统按照不同技术栈和服务职责进行部署，形成相对独立但通过网络互通的组件。典型部署方式如下：

（1）Web 前端部署方式。在开发阶段，前端基于 Vite 开发服务器运行，便于热更新和调试；在生产部署时，可以将构建后的静态资源（HTML、CSS、JavaScript 等）部署到 Web 服务器（如 Nginx）或由 Spring Boot 静态资源模块直接托管。前端通过配置好的后端接口地址，与后端 REST API 和 WebSocket 服务进行通信。

（2）Spring Boot 后端与 FastAPI 推理服务部署拓扑。后端应用打包为可执行 JAR 文件，运行在独立的 JVM 进程中，监听配置的端口（如 8099）。FastAPI 推理服务运行在 Python 环境中，通过 Uvicorn 启动，监听另一端口（如 8001）。后端通过配置文件中的 ml.fastapi.url 指定 FastAPI 服务地址，如 http://127.0.0.1:8001，在处理识别相关请求时向该地址发送 HTTP 请求。两者可以部署在同一物理机的不同进程中，也可以在不同服务器之间通过内网通信。

（3）MySQL 数据库部署与数据存储。MySQL 数据库运行在独立的数据库服务器或同一服务器的独立进程中，监听标准端口（如 3306）。后端通过 application.properties 中配置的数据源参数（包括 JDBC URL、用户名和密码等）连接数据库。系统业务数据（如用户、识别记录、知识条目、技术指导文章、商品、订单、支付记录等）均以结构化方式存储于数据库中。对于用户上传的图片文件，系统采用本地文件系统存储，在静态资源配置中将 file:uploads/ 加入资源路径，以便前端通过 URL 访问这些文件。

此外，后端配置中还预留了模型训练命令与数据集根目录配置项，用于在需要时触发 Python 端的模型训练脚本。训练过程通常运行在具备 GPU 能力的环境中，可以与在线推理服务部署在相同或不同机器上，但应通过合理的资源调度避免相互干扰。

## 3.3 功能模块划分

### 3.3.1 前端模块设计（基于 Vue Router）

前端位于 bysj-mtj-web 子项目中，通过 Vue Router 对各个功能页面进行模块化划分。根据路由配置，前端的主要模块包括：

（1）首页模块（HomeView）。首页用于为登录用户提供系统总览和入口导航，展示系统简介、推荐功能入口以及部分动态信息。用户可以从首页快速进入识别、历史记录、知识库、技术指导等核心功能模块。

（2）识别模块（DetectView）。识别页面是系统的核心交互界面之一，主要用于上传作物叶片图片并发起病害识别。页面通常包括图片选择/预览区域、识别按钮、识别进度和结果展示区等。识别完成后，页面展示物种名称、病害名称、置信度以及可能的 Top-K 候选结果，并提供跳转到知识库和技术指导页面的链接。

（3）历史记录模块（HistoryView）。该模块用于展示当前登录用户的历史识别记录列表，并支持按时间或条件进行筛选。用户可以点击某条历史记录查看具体的识别图片和诊断结果，以及与该记录关联的知识和技术指导内容。

（4）知识库模块（KnowledgeView）。知识库页面用于展示与各类作物及其病害相关的知识条目，支持按照作物类别、病害类别等维度进行分类浏览和搜索。每条知识条目通常包含病害概述、症状特征、病原介绍、防治措施等信息，为用户提供系统性的理论支持。

（5）技术指导模块（TechGuideListView、TechGuideDetailView）。技术指导列表页面展示专家或管理员发布的技术指导文章列表，支持按发布时间、热度等进行排序或筛选；详情页面用于展示单篇指导文章的全文内容，包括防治方案、施肥和用药建议、栽培管理技术等。

（6）聊天模块（ChatView）。消息或聊天页面用于展示用户与专家或系统之间的对话记录，支持消息发送和接收。前端通过 WebSocket 或其他方式与后端保持连接，实现新消息的实时推送和界面更新，为在线咨询和通知推送提供界面支撑。

（7）用户与个人中心模块（LoginView、RegisterView、ProfileView）。登录和注册页面用于完成用户身份认证，个人中心页面用于展示和修改用户基本信息，如昵称、头像、联系方式等。前端通过在路由元信息中配置 requiresAuth，结合导航守卫对这些页面访问进行控制。

（8）购物与订单模块（CartView、ShopItemDetailView、ShopPayView、OrdersView、ShopPayResultView）。该模块负责实现商品浏览与购买流程：商品详情页面展示单个商品的详细信息；购物车页面用于管理已选商品；支付页面用于确认订单并发起支付；订单列表页面展示用户的历史订单；支付结果页面根据后端返回结果展示支付状态。

（9）管理后台模块（AdminView）。该模块面向管理员用户，提供后台管理入口。管理员可以通过该页面进入用户管理、知识与技术指导管理、商品与订单管理、支付配置与系统监控等功能界面。前端在路由守卫中对访问 /admin 路由进行角色检查，防止非管理员用户访问后台。

通过上述模块划分，前端在路由层面实现了功能的清晰拆分，同时通过导航组件和统一布局（如在 App.vue 中实现的导航菜单和顶部状态显示条），为用户提供一致的使用体验。

### 3.3.2 后端业务模块设计（Spring Boot）

后端业务逻辑位于 springboot 子项目中，采用 Spring Boot 3 框架构建。结合前端的功能模块和数据库结构，后端可以在逻辑上划分为以下业务模块：

（1）用户与权限管理模块。该模块负责用户注册登录、角色划分和权限控制等功能，通常包括用户实体与角色实体的定义、用户注册与登录接口、密码加密与校验逻辑、基于角色的权限控制等。通过在控制器和路由层面对角色进行校验，实现普通用户、专家用户和管理员的功能区分。

（2）植物病害识别记录与历史管理模块。该模块负责接收来自前端的识别请求，将图片转发给 FastAPI 推理服务，并将识别结果与用户信息、图片路径一起持久化到数据库中。模块对外提供发起识别请求、查询识别结果和查询历史记录等接口，为前端识别页面和历史记录页面提供数据支撑。

（3）病害知识与技术指导管理模块。该模块用于维护病害知识条目和技术指导文章，通常包括知识与文章的增删改查接口，以及面向前端的列表和详情查询接口。管理员和专家用户通过后台接口对内容进行管理，普通用户通过查询接口浏览内容。

（4）商品、购物车与订单管理模块。该模块负责农资商品信息、购物车条目和订单记录的维护。对外提供商品列表与详情接口、购物车操作接口、订单创建与查询接口等。模块需要与支付模块协作，正确维护订单状态生命周期。

（5）支付宝支付集成与回调处理模块。该模块封装与支付宝沙箱环境交互的逻辑，通过配置文件中提供的网关地址、应用 ID、商户密钥、公钥等参数生成支付请求，并处理支付宝的同步和异步回调。回调处理逻辑负责验证签名、更新订单支付状态，并根据结果触发相应的业务后续处理。

（6）WebSocket 消息推送模块。该模块负责建立与前端的实时通信通道，为聊天、通知和系统状态推送提供支持。通过 WebSocket 或 STOMP 等技术，后端可以向指定用户或用户组推送新消息，使聊天和系统通知在前端界面中实时更新。

（7）与 FastAPI 模型服务交互模块。该模块是后端与 Python 端模型服务之间的桥梁，负责根据配置项 ml.fastapi.url 构造请求地址，与 FastAPI 服务的 /health 和 /predict 接口进行通信。模块应对网络异常和服务错误进行捕获和处理，为上层业务提供统一、稳定的模型调用接口。

通过以上模块划分，后端在逻辑上实现了职责单一、内聚性强的业务单元，为后续的扩展与维护提供了良好基础。

### 3.3.3 识别模型服务模块设计（FastAPI）

识别模型服务模块位于 pymodel 子项目中，采用 FastAPI 框架封装训练好的模型，并对外提供标准化的 HTTP 接口，主要包括：

（1）/health 心跳检测接口。该接口返回当前模型服务的基本状态信息，如模型是否加载完成、支持的物种类别数和病害类别数、运行设备（CPU 或 GPU）等。后端可以通过定期调用该接口监控模型服务是否在线，并将结果在前端界面上以状态标签的形式展示，提升系统可观测性。

（2）/predict 图像识别接口。该接口接收前端或后端上传的图片文件，首先调用叶片存在性二分类模型对图片进行预筛选，判断是否为无叶片背景或疑似背景；对于符合条件的图片，再分别调用物种识别模型和病害识别模型进行分类，最终返回包含物种名称、病害名称、置信度以及 Top-K 候选列表的结构化结果。

（3）与后端配置项 ml.fastapi.url 的集成方式。FastAPI 服务的地址和端口在后端配置文件中以 ml.fastapi.url 的形式给出，例如 http://127.0.0.1:8001。后端业务模块在处理识别请求时，从配置中读取该地址，构造请求 URL 调用 /predict 接口；在进行健康检查时，则调用 /health 接口。通过配置化的方式实现后端与模型服务之间的松耦合，便于在不同部署环境中灵活调整模型服务地址。

## 3.4 关键技术介绍

### 3.4.1 前端关键技术

前端系统采用 Vue3 组合式 API 与 TypeScript 技术栈构建，结合 Element Plus 组件库和现代构建工具实现。其关键技术点包括：

（1）Vue3 组合式 API + TypeScript。前端通过组合式 API 将组件逻辑拆分为多个函数和响应式变量，使得状态管理和逻辑复用更加清晰。同时引入 TypeScript 对组件的属性、状态和函数进行类型标注，提高了代码的可读性和可维护性，减少运行时类型错误的发生。

（2）Element Plus 组件库的使用。系统在布局、表单、表格、对话框、通知等常见界面元素上广泛采用 Element Plus 组件，从而快速构建整洁一致的用户界面。通过对主题样式和组件配置的适度定制，使系统兼具美观性和实用性，提升了整体用户体验。

（3）前端路由与导航守卫。前端使用 Vue Router 管理路由，结合路由元信息中的 requiresAuth 标记和用户角色信息，在导航守卫中进行登录校验和权限检查。例如，当用户访问需要登录的页面时，若本地会话中不存在用户信息，则自动跳转到登录页面；当用户访问管理后台页面时，若其角色不是管理员，则被重定向到首页。通过这一机制，可以在前端层面实现细粒度的访问控制，配合后端的权限校验提高系统安全性。

### 3.4.2 后端关键技术

后端系统基于 Spring Boot 3 框架构建，结合多种常用组件和第三方库实现业务逻辑与系统支撑功能，主要技术点包括：

（1）Spring Boot 3 框架。Spring Boot 通过自动配置和约定优于配置的理念，大幅降低了项目搭建和配置的复杂度。后端在该框架下实现了控制器层、服务层、数据访问层以及配置层等部分，形成结构清晰、便于维护的标准化工程。

（2）Spring Data JPA 与 MySQL 数据持久化。后端通过 Spring Data JPA 提供的仓库接口对 MySQL 数据库进行操作，简化了常见的增删改查逻辑。实体类与数据库表之间通过注解进行映射，开发者可以通过定义接口方法名称的方式快速实现查询逻辑，从而提升开发效率。

（3）WebSocket 实时通信。为实现聊天消息和系统通知的实时推送，后端引入了 WebSocket 支持。通过在服务器端维护与前端的长连接通道，可以在有新消息或状态变更时主动推送给客户端，从而避免频繁轮询带来的性能消耗和延迟，提高用户体验。

（4）Jsoup、PDFBox 等第三方库的用途。后端项目中集成了 Jsoup 和 Apache PDFBox 等第三方库，为后续对技术文档、知识内容进行 HTML 解析、PDF 报告生成等功能提供工具支持。例如，可以利用 Jsoup 对外部网页的农技资讯内容进行抓取和解析，利用 PDFBox 将重要的技术指导内容导出为 PDF 文档，方便线下查阅和存档。

（5）支付宝 Java SDK 的集成。系统通过引入支付宝 SDK 完成与支付宝沙箱环境的对接，利用配置文件中提供的网关地址、应用 ID、商户私钥、公钥等参数，生成支付请求并处理支付回调。SDK 封装了签名验证、参数构造等底层细节，使系统能够安全、规范地处理支付流程。

### 3.4.3 识别模型与推理服务关键技术

识别模型与推理服务位于 pymodel 子项目中，采用 PyTorch 和 TorchVision 作为深度学习基础框架，结合 FastAPI 和 Uvicorn 构建高性能推理服务。该部分既包括模型结构本身，也包括训练方法和部署方式，是本系统的技术核心之一。

（1）PyTorch 与 TorchVision 深度学习框架。PyTorch 以动态图计算和良好的可扩展性著称，适合进行模型原型设计与调试；TorchVision 则提供了常用的图像变换操作和预训练模型。本系统利用 TorchVision 提供的数据增强与预处理功能（如 Resize、CenterCrop、RandomResizedCrop、ColorJitter 等），构建适合 PlantVillage 数据集的输入流水线；同时使用预训练的 MobileNetV2 网络作为基础模型，在其分类头之上进行迁移学习。

（2）MobileNetV2 轻量级卷积神经网络。考虑到未来在资源受限环境下部署的需要，系统选择 MobileNetV2 作为物种识别模型和病害识别模型的主干网络。MobileNetV2 采用深度可分离卷积和倒残差结构，在保持较高准确率的前提下显著降低了参数量和计算量。通过替换网络末端的分类器层并适配具体的类别数（物种类别数和病害类别数），系统可在 PlantVillage 数据集上完成对不同作物及其病害的分类任务。

（3）两阶段识别框架与叶片存在性模型。PlantVillage 数据集中包含名为 Background_without_leaves 的纯背景类，如果不加区分地与病害图像一起训练，容易导致模型在实际应用中误将纯背景图片判为某种病害。为解决这一问题，系统单独训练了一个叶片存在性二分类模型，将“无叶片背景”作为负类、其他所有类别作为正类。在推理阶段，FastAPI 服务首先调用叶片存在性模型对输入图片计算“无叶片背景”概率和“有叶片”概率，若前者超过严格阈值，则直接判定为纯背景；若处于中间区间，则提示用户疑似背景并建议重新拍摄；仅当图片被判定为含叶片时，才进入物种与病害识别阶段。

（4）数据集划分与数据增强策略。系统在 config.py 中对数据路径、图像大小、批大小、训练轮次等参数进行了集中配置，数据集基于 PlantVillage 原始目录结构组织，并通过脚本生成物种类别名和病害类别名的 JSON 文件，避免训练和部署阶段类别索引不一致。数据集在划分为训练集、验证集和测试集时，确保同一图像不会同时出现在多个子集中，以便对模型的泛化能力进行客观评估。在数据增强方面，根据配置项选择“轻度”“中等”或“强力”增强策略，通过随机裁剪、翻转、旋转和颜色抖动等操作提高模型对光照变化、拍摄角度和背景干扰的鲁棒性。

（5）模型训练流程与超参数设置。主训练脚本 train.py 负责解析命令行参数（如任务类型 --task、设备选择 --device、是否从断点恢复训练 --resume、随机种子 --seed 等），根据任务类型在运行时填充类别名称列表和模型保存路径，然后构建 MobileNetV2 模型并加载相应的预训练权重。训练过程中使用交叉熵损失函数，辅以标签平滑以提高模型泛化能力；通过设置 BATCH_SIZE、LEARNING_RATE、WEIGHT_DECAY、EPOCHS 等超参数以及冻结策略（如部分冻结特征层，仅对后期层进行微调），在训练速度与精度之间取得平衡。训练过程还引入早停机制和学习率调度器，当验证集性能长时间未提升时自动降低学习率或提前终止训练，以避免过拟合和资源浪费。

（6）叶片存在性模型训练与阈值校准。在 leaf_presence.py 中，系统构建了一个专门用于叶片存在性判别的数据集，将所有非背景类样本标记为 1，将 Background_without_leaves 目录中的样本标记为 0。训练时采用类权重平衡策略缓解类别不均衡问题，并使用中等强度的数据增强提高模型对真实场景的适应能力。训练完成后，系统还提供阈值校准函数，对验证集上的“无叶片背景概率”进行统计，寻找能在召回背景与避免误杀正常叶片之间取得较好平衡的阈值组合，并将推荐阈值写入配置，以指导两阶段识别中的拦截逻辑。

（7）FastAPI 推理服务与 GPU 加速。FastAPI 应用在启动时加载训练好的叶片存在性模型、物种模型和病害模型，并根据配置选择运行设备（GPU 或 CPU）。在 GPU 可用时启用 GPU 和混合精度训练/推理；在 Windows 等环境中，通过设置线程数和禁用部分共享内存功能，避免资源冲突。推理过程使用 Uvicorn 作为 ASGI 服务器，结合 FastAPI 的异步特性，实现高并发请求下的稳定响应。通过健康检查接口，后端可以实时了解模型服务当前运行状态，从而在前端界面中显示“模型服务在线/离线”等状态提示。

综上，本系统在识别模型与推理服务部分采用了轻量化网络结构、两阶段识别策略以及合理的训练与部署方案，为整个平台的诊断准确率和响应性能提供了坚实保障。

## 3.5 UML 设计

### 3.5.1 系统包图

为从宏观结构上刻画系统各部分之间的依赖关系，可以通过 UML 包图对系统进行抽象划分。整体上，系统可以划分为以下几类包或子系统：

（1）前端表示层包。包括前端的视图组件、路由配置和通用组件等，主要负责界面展示和用户交互，通过 HTTP 和 WebSocket 与后端通信。

（2）后端接口与控制器包。包括 Spring MVC 控制器、请求映射和参数校验等内容，对外暴露 RESTful API 和 WebSocket 端点，负责接收前端请求并调用相应业务服务。

（3）业务服务与领域逻辑包。包括用户与权限、识别记录、知识与技术指导、商品与订单、支付、消息等领域的服务类，实现具体业务规则和工作流程，是后端逻辑的核心所在。

（4）数据访问与实体包。包括实体类、仓库接口以及与数据库表之间的映射关系，负责持久化相关操作。业务服务层通过调用仓库接口访问 MySQL 数据库，实现对领域对象的增删改查。

（5）模型服务集成包。包括后端与 FastAPI 推理服务交互的封装逻辑，如调用 /health 和 /predict 接口的客户端代码、异常处理和重试机制等，实现对模型服务的统一访问。

（6）Python 端模型与服务包。位于 pymodel 子项目中，包括模型定义、训练脚本、数据加载工具、推理服务和配置文件等。该包独立于 Java 端运行，通过 FastAPI 提供面向 HTTP 的服务接口。

通过上述包的划分，系统在 UML 包图中形成自上而下的依赖关系：前端依赖后端接口，后端控制器依赖业务服务层，业务服务层依赖数据访问层和模型服务集成层，而模型服务集成层与 Python 端模型服务之间则通过网络调用进行连接。

### 3.5.2 核心类图

在类层面上，系统围绕用户与权限、病害知识与技术指导、识别记录与图片资源以及商品与订单等领域构建了一系列核心类。虽然实际实现中类名和属性会随具体编码略有差异，但在设计类图时，主要考虑以下几类对象及其关系：

（1）用户、角色与权限相关类。设计中通常包括“用户”类、“角色”类以及可能的“权限”类或角色枚举。用户类包含用户名、密码散列、昵称、联系方式、创建时间等属性，并通过关联关系与角色类相连；角色类反映用户在系统中的身份，如普通用户、专家用户和管理员等。系统通过在控制器和服务层检查用户角色信息，实现对后台管理界面、知识编辑、订单管理等操作的权限控制。

（2）病害知识与技术指导文章相关类。在病害知识领域，可以设计“知识条目”类，包含标题、作物类型、病害类型、病害概述、症状描述、防治措施等属性；在技术指导领域，可以设计“技术指导文章”类，包含文章标题、正文内容、作者、发布时间、关联作物或病害等属性。知识条目和技术指导文章可以与用户类（例如专家用户）建立关联关系，用于记录内容的创建者或维护者。

（3）识别记录与图片资源相关类。在识别记录领域，可以设计“识别记录”类，用于保存每一次识别请求的关键信息，包括记录编号、所属用户、上传时间、图片路径、识别出的物种和病害名称、置信度分值、调用模型的状态等；同时可以设计“图片资源”或利用简单路径字段，表示图片在文件系统中的存储位置。识别记录与用户之间是一对多关系，即一个用户可以对应多条识别记录。

（4）商品、订单与支付相关类。在交易领域，可以设计“商品”类（包含商品名称、价格、库存、适用作物/病害、图片等属性）、“订单”类（包含订单编号、用户、订单时间、总金额、状态等属性）、“订单项”类（用于描述订单中某个具体商品及其数量），以及必要时用于记录支付流水的“支付记录”类等。商品与订单项之间是一对多关系，订单与订单项之间同样是一对多关系；订单与用户之间是一对多关系。支付记录通常与订单一一对应，用于记录与支付平台的交互结果。

通过上述核心类及其关联关系，可以在类图中清晰呈现系统的主要数据结构和业务对象，为数据库模式设计和代码实现提供依据。

### 3.5.3 典型时序图

为更直观地展示系统在运行过程中的动态行为，本节从时序图的角度，对“植物病害识别业务流程”和“下单与支付流程”两个典型场景进行描述，并结合识别模型的训练与推理方式进行说明。

（1）植物病害识别业务流程时序图。以普通用户发起一次病害识别为例，主要交互步骤如下：

•	用户在浏览器中打开前端识别页面，在界面上选择或拍摄叶片图片并点击“开始识别”按钮；

•	前端将图片数据封装为 HTTP 请求，通过后端暴露的识别接口发送到 Spring Boot 应用；

•	后端控制器接收到请求后，进行基本参数校验，并将图片转发给模型服务集成模块；

•	模型服务集成模块根据配置项构造 FastAPI 服务的 /predict URL，将图片以表单数据方式发送到 pymodel 中的 FastAPI 应用；

•	FastAPI 应用首先调用叶片存在性模型，对图片进行无叶片背景拦截；若图片存在叶片，则继续调用物种识别模型和病害识别模型，生成预测结果和 Top-K 候选列表；

•	FastAPI 将识别结果打包为 JSON 返回给后端；

•	后端解析返回结果，并将识别记录、图片路径和用户信息一起写入数据库；

•	后端将结构化的识别结果返回给前端，前端根据结果刷新界面，展示物种名称、病害名称、置信度及相关知识推荐链接。

该时序图清晰体现了浏览器前端、Spring Boot 后端、FastAPI 模型服务以及数据库之间的调用顺序和数据流转过程。

（2）下单与支付流程时序图。以用户购买某种农资商品为例，主要交互步骤如下：

•	用户在前端商品详情页面选择商品及数量，并将其加入购物车；

•	用户在购物车页面点击“结算”进入订单确认页面，确认收货信息和总金额后提交订单；

•	前端将订单请求发送至后端订单管理模块，后端创建订单记录并返回支付链接或支付参数；

•	前端根据返回信息跳转到支付宝沙箱支付页面或调起支付窗口，用户在支付宝页面完成支付流程；

•	支付宝在支付完成后通过同步回调将结果返回给后端，同时通过异步通知接口推送支付结果；

•	后端支付模块验证回调请求的签名和参数，在验证通过后更新订单状态，并根据需要记录支付流水；

•	用户在系统订单页面刷新后即可看到最新的订单状态，如“已支付”“已取消”等。

该时序图展示了前端、后端订单模块、支付模块与支付宝支付网关之间的交互逻辑，反映了交易流程中的关键步骤和安全控制点。

（3）模型训练与部署流程补充说明。虽然模型训练过程通常不在日常在线业务中频繁触发，但从系统设计角度，仍可以通过时序图对其进行抽象描述。例如，当管理员或开发者在具备 GPU 的环境中执行训练脚本时：

•	训练脚本 train.py 被启动，首先读取 config.py 中的数据路径、训练参数和设备配置；

•	脚本调用数据加载模块构建训练集、验证集和测试集的 DataLoader，应用数据增强和预处理；

•	脚本调用模型定义模块初始化 MobileNetV2 主干网络，并根据任务类型（物种识别或病害识别）调整输出层和模型保存路径；

•	训练循环中，脚本依次执行前向传播、损失计算、反向传播和参数更新，并在每个 epoch 后在验证集上评估性能；

•	当验证集性能达到新高时，脚本将当前模型权重保存到指定路径；当触发早停条件或训练轮次结束时，脚本退出并生成训练曲线等可视化结果；

•	FastAPI 推理服务在下一次启动或检测到模型权重更新时，从新的权重文件加载模型，完成线上模型的更新。

通过对训练和部署流程的时序描述，可以从整体上把握数据集、模型、训练脚本和推理服务之间的关系，展示系统在模型生命周期管理方面的设计思路。

综上，本章从总体架构、功能模块划分、关键技术和 UML 视角对系统进行了全面的总体设计说明，为后续第4章的详细设计与实现奠定了基础。

# 第四章 系统详细设计与实现

本章在第2章需求分析和第3章总体设计的基础上，从数据集与预处理、识别模型设计与训练实现、推理服务实现以及业务系统前后端与数据库实现四个方面，对系统进行详细设计与说明。重点突出识别模型相关内容，包括数据集划分、模型训练流程与关键技术实现细节。

## 4.1 数据集与数据预处理

### 4.1.1 PlantVillage 数据集介绍

本系统的植物病害识别部分以 PlantVillage 数据集为主要数据来源。PlantVillage 是国际上广泛使用的植物病害公开数据集之一，包含多种作物的叶片图像及其对应病害标注，具有样本量大、病害类型丰富、标注规范等特点，适合作为深度学习模型的训练和评估基准数据集。

在本课题中，PlantVillage 数据集被组织在 pymodel/data/PlantVillage 目录下，目录结构沿用了原始数据集以“类别名”划分子目录的方式。每个子目录对应一种“作物+病害”组合或背景类，目录名称一般为 “作物名_病害名” 的形式，例如某些目录名称形如 Apple___Apple_scab、Tomato___Late_blight 等，此外还存在名为 Background_without_leaves 的纯背景类目录。目录结构示意如下：

data/PlantVillage/

Apple___Apple_scab/

Apple___Black_rot/

Tomato___Early_blight/

Tomato___Late_blight/

...

Background_without_leaves/

在实际使用中，系统需要同时关注“物种”（即作物种类）和“病害类型”两个维度：前者描述图像中叶片所属作物，后者描述叶片是否患病以及属于哪种病害。因此，在后续的数据预处理和模型设计中，会将原始类别名按 作物名___病害名 的结构进行拆分，并构建物种类别集合与病害类别集合，为双模型任务做准备。

### 4.1.2 数据清洗与质量过滤

原始数据集中可能存在部分低质量或不符合预期的图像，例如分辨率过小、长宽比极端、被严重裁切或拼接的图片等。这类样本如果直接用于训练，容易影响模型的收敛速度和泛化能力。为提高数据质量，本系统在 config.py 中对数据质量控制进行了集中配置，并配合数据过滤脚本对不合格样本进行清洗。

在配置文件中，相关参数包括：

•	FILTER_BAD_IMAGES：布尔开关，指示是否启用数据质量过滤机制；

•	BAD_IMAGE_PATTERNS：包含多种用于识别可能裁剪或拼接图像的关键字列表（如 "crop"、"cropped"、"拼接" 等），当文件名中包含这些模式时，将该图像视为可疑样本；

•	MIN_IMAGE_SIZE：最小图像边长阈值（如 80 像素），低于该阈值的图像被视为尺寸过小，不适合作为模型输入；

•	MAX_ASPECT_RATIO：最大长宽比阈值，超过该阈值的图像可能为异常裁切或异常拼接样本，需要剔除。

数据清洗时，系统会遍历 PlantVillage 目录下的所有类别文件夹，对每张图像执行如下检查：

1.	读取图像的宽度和高度，若最短边小于 MIN_IMAGE_SIZE，则将该图像标记为无效样本；

2.	计算宽高比，若长宽比超过 MAX_ASPECT_RATIO，则视为可能异常裁切或拼接图像，予以过滤；

3.	检查文件名是否包含 BAD_IMAGE_PATTERNS 中的关键字，若匹配，则将该样本排除在训练集之外。

通过上述过滤规则的综合应用，可以有效剔除一部分质量较差或不符合预期的数据，从而提升训练数据的整体质量，为后续模型训练打下更好的基础。

### 4.1.3 数据集划分策略

为了科学评估模型的性能并避免数据泄漏，系统对 PlantVillage 数据集进行了训练集、验证集和测试集的划分。在数据加载模块中，会按照一定比例（例如 7:2:1 或类似配置）将各类别样本分配到不同子集，保证各子集中类别分布尽量均衡，避免过于偏斜的数据划分导致评估结果失真。

在划分过程中，系统特别对类别名称进行了整理和持久化处理：

•	在 config.py 中定义了 SPLITS_DIR 目录，用于存放与数据划分和类别名相关的文件；

•	通过数据加载脚本从 PlantVillage 目录中扫描类别名，分别提取出物种名称集合和病害名称集合，并将其保存到 species_class_names.json 和 disease_class_names.json 两个 JSON 文件中，路径由 SPECIES_CLASS_NAMES_JSON 和 DISEASE_CLASS_NAMES_JSON 配置指定；

•	在模型训练和推理阶段，通过读取上述 JSON 文件，确保类别索引与类别名称之间的映射关系保持一致。

另外，为避免 Background_without_leaves 这一纯背景类别对主任务（物种识别和病害识别）造成干扰，系统在 config.py 中通过 EXCLUDE_CLASSES = ["Background_without_leaves"] 的方式，将该类别从主任务的训练集中剔除。这样，在物种和病害识别模型训练时，只使用包含真实叶片的类别；纯背景样本则单独用于训练叶片存在性二分类模型，从而形成清晰的任务边界。

### 4.1.4 数据增强策略

为提高模型对光照变化、图像噪声、拍摄角度变化等因素的鲁棒性，本系统在数据加载阶段引入了多种数据增强策略。在配置文件中，通过 AUGMENTATION_LEVEL 参数对增强强度进行整体控制（例如 light、medium、heavy 等），在具体实现中则结合 TorchVision 提供的变换操作构建增强流水线。

常用的数据增强操作包括：

•	随机裁剪与缩放：使用 RandomResizedCrop 或 Resize + RandomCrop 等操作，对输入图像进行随机裁剪和缩放，以模拟不同拍摄距离和取景范围；

•	随机翻转：使用 RandomHorizontalFlip 等操作，对图像进行水平翻转，增强模型对左右对称场景的适应能力；

•	随机旋转：通过 RandomRotation 在一定角度范围内旋转图像，使模型对拍摄角度变化更加鲁棒；

•	颜色抖动：使用 ColorJitter 对亮度、对比度、饱和度和色相等进行轻微扰动，模拟不同光照条件和相机设置。

在训练阶段，为物种识别、病害识别和叶片存在性判别等任务分别构建了适配的训练增强和验证/测试预处理流水线：训练集使用较为丰富的随机变换，验证集和测试集则使用统一的 Resize + CenterCrop + Normalize 组合，以保证评估结果的可比性和稳定性。

## 4.2 识别模型总体设计

### 4.2.1 任务定义与总体框架

基于第3章的总体架构，本系统在识别模型部分定义了三个相互关联但目标不同的子任务：

（1）物种识别任务（Species Classification）。给定一张作物叶片图像，判断其所属的作物种类（如苹果、番茄、葡萄等）。该任务关注“是什么作物”的问题，输出空间为物种类别集合 SPECIES_CLASS_NAMES。

（2）病害识别任务（Disease Classification）。在已知图像中包含作物叶片的前提下，判断叶片是否患病以及属于哪种病害类型（包括健康和具体病害类别）。该任务输出空间为病害类别集合 DISEASE_CLASS_NAMES，对“是否患病、患什么病”进行分类。

（3）叶片存在性判别任务（Leaf Presence Classification）。在真实应用中，用户上传的图片可能并不总是包含清晰的作物叶片，有可能是土壤、器具或其他背景场景。若直接将这类图片输入病害识别模型，容易导致误判。因此，系统引入叶片存在性二分类模型，将“无叶片背景”与“包含叶片”进行区分，为后续病害识别提供前置过滤。

在总体框架上，系统采用“两阶段识别”策略：

•	阶段 1：叶片存在性拦截。先将输入图像送入叶片存在性二分类模型，计算其属于“无叶片背景”与“有叶片”的概率。当“无叶片背景”概率高于配置的严格阈值时，直接将图片判定为背景并返回相应提示；当概率处于中间区域时，提示用户图片可能不包含明显叶片，建议重新拍摄；只有当判定图片中存在叶片时，才进入阶段 2；

•	阶段 2：物种识别与病害识别。对通过叶片存在性过滤的图片，分别送入物种识别模型和病害识别模型，得到作物种类预测结果和病害类型预测结果。系统同时计算并返回 Top-K 候选类别及其置信度，为用户提供更多参考信息。

通过上述两阶段框架，系统在保证诊断准确率的同时，有效减少了对纯背景和无效图片的误判，提升了整体用户体验和模型输出的可靠性。

### 4.2.2 模型结构选择与对比

在模型结构选择上，本系统主要关注以下几个方面：识别精度、推理速度和部署成本。传统的 ResNet、DenseNet 等网络虽然在许多图像分类任务上表现优异，但网络参数较多、计算量较大，不利于在资源受限环境或需要高并发请求的场景下部署。

为此，本系统选用 MobileNetV2 作为物种与病害识别模型的主干网络。MobileNetV2 是一类轻量级卷积神经网络，采用深度可分离卷积和倒残差结构，在大幅降低参数量和计算量的同时，仍能保持较高的分类性能。这使其非常适合部署在 GPU/CPU 资源有限或需要快速响应的 Web 推理服务中。

相比传统的大型网络，MobileNetV2 的优势主要体现在：

•	模型尺寸小、内存占用低，有利于在服务器或边缘设备上进行部署与快速加载；

•	计算复杂度较低，推理速度快，更适合在线实时识别服务；

•	借助 TorchVision 提供的预训练权重，可以在 ImageNet 上预训练的基础上进行迁移学习，缩短训练时间并提升在农作物病害任务上的收敛速度和精度。

综合考虑上述因素，本系统分别基于 MobileNetV2 构建了物种识别模型和病害识别模型，并在此基础上引入独立的叶片存在性二分类模型，形成整体识别框架。

## 4.3 模型结构与训练细节

### 4.3.1 MobileNetV2 主干结构设计

MobileNetV2 的核心结构为一系列倒残差瓶颈块（Inverted Residual Blocks），每个瓶颈块通过“1×1 卷积升维 → 3×3 深度可分离卷积 → 1×1 卷积降维”的结构将低维特征映射到高维空间进行卷积运算，再映射回低维空间，并在输入和输出之间引入残差连接，从而在保证模型表达能力的前提下减少计算量。

在本系统中，物种与病害识别模型均使用 TorchVision 提供的 MobileNetV2 预训练权重作为主干网络，在此基础上对最后的分类器部分进行修改：

•	保留主干网络的大部分卷积层和倒残差块，以充分利用预训练模型中学到的通用视觉特征；

•	替换末端的全连接分类头，将原本针对 ImageNet 1000 类的输出层替换为适配物种类别数或病害类别数的新输出层；

•	在新的分类头中加入适当的 Dropout 层（如 0.3 左右），以缓解过拟合，尤其是在某些类别样本数相对较少的情况下。

这样设计的 MobileNetV2 主干既能保持较高的特征表达能力，又能通过少量参数调整适应特定的 PlantVillage 子任务，实现精度与效率的平衡。

### 4.3.2 物种识别模型

物种识别模型以 MobileNetV2 为 backbone，其输出空间与 SPECIES_CLASS_NAMES 中保存的物种类别名一一对应。在训练与推理过程中，系统通过以下方式管理物种模型：

在数据加载阶段，扫描 PlantVillage 数据集中各类别目录的前缀（即 作物名___病害名 中的“作物名”部分），将所有不同的作物名收集为集合；

将该集合排序并保存至 species_class_names.json 文件中，在运行时通过配置中的 SPECIES_CLASS_NAMES_JSON 路径读取；

在构建物种模型时，根据类别名列表的长度确定输出层神经元个数；

在训练脚本中，通过设置 SPECIES_MODEL_SAVE_PATH 配置项指定物种模型权重保存路径，在训练过程中每当验证集性能提升时更新保存；

在 FastAPI 推理服务启动时，通过 get_model(num_classes=len(SPECIES_CLASS_NAMES)) 构建物种模型，随后使用安全加载函数将 SPECIES_MODEL_SAVE_PATH 中的权重加载到模型中，并设置为评估模式。

通过上述设计，物种识别模型能够根据输入图像输出对应的作物种类预测结果，为后续病害识别结果提供上下文信息或用于前端展示。

### 4.3.3 病害识别模型

病害识别模型的整体结构与物种识别模型类似，同样以 MobileNetV2 为 backbone，不同之处在于其输出空间与 DISEASE_CLASS_NAMES 中的病害类别名对应。在训练与推理过程中，主要流程为：

在数据加载阶段，对 PlantVillage 数据集中的类别目录名进行解析，将 作物名___病害名 中的“病害名”部分提取出来，并对包含“健康”状态的类别进行统一归类；

将整理后的病害类别集合排序后保存至 disease_class_names.json 文件，路径由 DISEASE_CLASS_NAMES_JSON 配置指定；

在构建病害识别模型时，根据病害类别数调整 MobileNetV2 分类头的输出维度；

通过 DISEASE_MODEL_SAVE_PATH 配置项指定病害模型权重保存路径；

在 FastAPI 服务启动时，构建病害识别模型并加载权重，同样设置为评估模式。在推理阶段，对输入图像输出病害类别概率分布，并据此计算主预测结果和 Top-K 候选列表。

物种识别与病害识别模型相互独立但共享类似的结构设计，两者共同构成系统对输入图像的双维度诊断能力。

4.3.4 叶片存在性二分类模型

叶片存在性二分类模型的目标是判断输入图像是否包含作物叶片，从而在推理阶段实现对纯背景和严重无效图片的前置过滤。该模型的设计要点如下：

•	任务定义为二分类：0 类为“无叶片背景”（主要来自 PlantVillage 中的 Background_without_leaves 目录），1 类为“有叶片”（来自除背景外的所有类别目录）；

•	模型结构同样基于 ImageNet 预训练的 MobileNetV2，将其分类头替换为适配 2 类输出的全连接层，并在全连接层之前加入 Dropout，以提升泛化能力；

•	在数据构建过程中，系统通过遍历 PlantVillage 目录下各个子目录，将 Background_without_leaves 中的样本标记为 0，其余类别中的样本标记为 1，构建一个二分类数据集。

考虑到 PlantVillage 中非背景样本数量远多于背景样本，若不加处理，训练过程容易出现类别不平衡问题。为此，系统在叶片存在性模型训练中采用了以下策略：

•	对正负样本进行子采样，限制最大正类和负类样本数量，以提升训练稳定性和效率；

•	统计训练集中正负样本数量，根据样本数计算类别权重，并在交叉熵损失函数中引入类别权重参数，以减轻类别不平衡带来的影响；

•	采用中等强度的数据增强策略，增加模型对多样化背景条件的适应性。

通过上述设计，叶片存在性二分类模型可以较为准确地区分纯背景与含叶片图像，为两阶段识别框架提供可靠的前置判断。

### 4.3.5 训练超参数与优化策略

模型训练过程中的超参数和优化策略集中在 config.py 中进行配置，便于统一管理和后续调整。主要参数包括：

批大小（BATCH_SIZE）：用于控制每个训练批次处理的样本数，影响训练速度和显存占用；

图像尺寸（IMAGE_SIZE）：统一输入图像的尺寸，如 224×224，与 MobileNetV2 默认输入相匹配；

训练轮次（EPOCHS）：决定遍历训练集的次数，通常结合早停机制使用；

学习率（LEARNING_RATE）与权重衰减（WEIGHT_DECAY）：控制参数更新步伐和正则化强度，是影响模型收敛性能的关键参数；

冻结策略（FREEZE_STRATEGY）与解冻层数（UNFREEZE_LAST_BLOCKS）：用于控制在迁移学习过程中哪些卷积层参与微调，通过“完全冻结”“部分冻结”“仅冻结 BatchNorm 层”等策略，在训练速度和精度之间取得折中；

标签平滑（LABEL_SMOOTHING）：在交叉熵损失中对目标标签进行平滑处理，有助于提升模型泛化能力；

早停耐心值（EARLY_STOP_PATIENCE）与学习率调度耐心值（LR_SCHEDULER_PATIENCE）：用于在验证集性能长时间不提升时降低学习率或提前终止训练，避免过度训练和不必要的资源消耗；

混合精度训练开关（USE_AMP）和 cudnn 性能优化选项：在 GPU 环境下启用混合精度可以减少显存占用并加速训练，而启用 cudnn 的 benchmark 模式可以对常用卷积算法进行选择优化。

通过合理设置上述超参数并结合实验调优，系统在 PlantVillage 数据集上获得了较为稳定和高效的训练过程，为模型在实际部署中的表现提供了保障。

## 4.4 模型训练流程实现

### 4.4.1 主训练脚本设计

主训练脚本 train.py 是物种识别和病害识别模型训练流程的入口。其整体流程可概括为以下几个步骤：

（1）命令行参数解析。脚本通过 argparse 定义了任务类型（--task，取值为 species 或 disease）、设备选择（--device，如 cuda:0 或 cpu）、是否从断点恢复（--resume）以及随机种子（--seed）等参数，便于在不同训练配置之间快速切换。

（2）日志系统初始化。脚本通过专门的日志工具初始化训练日志记录器，用于在控制台或日志文件中输出训练进度、损失值、准确率等信息，便于追踪训练过程并定位潜在问题。

（3）设备选择与性能优化。根据命令行参数和系统环境，脚本优先选择可用的 GPU 设备作为训练设备；若 GPU 不可用，则回退到 CPU。在检测到 GPU 可用时，启用 cudnn 的 benchmark 模式以提升卷积运算性能。

（4）随机种子设定。脚本统一设置 Python、NumPy 和 PyTorch 等随机数生成器的种子，保证训练过程在给定配置下具有较好的可复现性。

（5）数据加载。训练脚本调用数据加载模块的接口，根据任务类型构建训练集、验证集和测试集的 DataLoader。数据加载过程中会应用前文提到的数据清洗和数据增强策略，并根据配置决定是否使用类别均衡采样等技术。

（6）模型构建。根据任务类型，将全局配置中的类别名列表和模型保存路径填充为物种或病害对应的版本，然后调用模型构建函数 get_model(num_classes=...) 创建 MobileNetV2 模型实例，并根据需要冻结部分特征层参数，仅对分类头或少数后期层进行微调。

（7）模型训练与验证。脚本调用训练工具模块中的 train_model 函数，将模型、训练集和验证集 DataLoader 以及恢复训练标志等参数传入，执行多轮训练。在训练期间，函数会记录每个 epoch 的训练损失和验证性能，并根据配置实现早停和学习率调度等策略。

（8）训练结果可视化与输出。训练完成后，脚本调用可视化工具函数绘制训练曲线（如损失曲线和准确率曲线），并通过日志输出最佳模型保存路径和验证集表现，提示用户可以继续使用测试脚本或预测脚本对模型进行进一步评估和使用。

通过上述设计，主训练脚本实现了从配置、数据、模型到训练与输出的一体化流程管理，便于在不同任务和环境下复用和扩展。

### 4.4.2 叶片存在性模型训练与校准

叶片存在性模型的训练流程主要在 leaf_presence.py 中实现，其核心步骤包括：

（1）数据集构建。脚本定义了 BinaryImageDataset 数据集类，用于从 PlantVillage 目录中同时收集背景类和非背景类样本。在初始化时，数据集扫描 Background_without_leaves 目录，将其中的图像标记为 0（无叶片背景），其余类别目录中的图像标记为 1（有叶片），并记录样本路径和标签。

（2）子采样与划分。考虑到正负样本数量差距较大，脚本对正负样本进行子采样，限制最大保留样本数，并将采样后的数据集划分为训练集和验证集，以减少训练时间并提升稳定性。

（3）数据增强与 DataLoader 构建。脚本为训练集和验证集分别定义了数据变换流水线：训练集使用包含 RandomResizedCrop、RandomHorizontalFlip、RandomRotation 和 ColorJitter 的增强组合，验证集使用 Resize + CenterCrop + Normalize 的标准预处理。随后基于这些数据集和变换构建 DataLoader，用于批量加载数据进行训练。

（4）模型与损失函数设置。脚本创建基于 MobileNetV2 的叶片存在性二分类模型，并根据训练集中正负样本数量计算类别权重，构造带有类别权重和标签平滑的交叉熵损失函数，以减轻类别不均衡和过拟合问题。

（5）训练循环与最优模型保存。在训练循环中，脚本对每个批次执行前向传播、损失计算、反向传播和参数更新，同时在每个 epoch 结束后在验证集上评估准确率。一旦验证准确率超过历史最佳值，便将当前模型权重保存到配置的 LEAF_PRESENCE_MODEL_PATH 路径中，确保最终部署使用表现最佳的权重。

（6）阈值校准。脚本提供了 calibrate_thresholds 函数，用于在训练完成后基于验证集对“无叶片背景概率”的分布进行统计，评估在不同阈值下的召回率、特异性、假阳性率和假阴性率等指标，并推荐普通阈值和严格阈值组合。系统根据校准结果更新 LEAF_PRESENCE_THRESHOLD 和 LEAF_PRESENCE_NO_LEAF_THRESHOLD 等配置，为两阶段识别框架提供更合理的拦截边界。

### 4.4.3 模型保存与加载策略

为保证模型权重文件的安全性和兼容性，系统在保存和加载模型时采用了统一的策略：

训练阶段，当验证集性能提升时，会调用 PyTorch 的 torch.save 将模型状态字典保存到配置指定的路径下，如 SPECIES_MODEL_SAVE_PATH、DISEASE_MODEL_SAVE_PATH 和 LEAF_PRESENCE_MODEL_PATH。所有权重均存放在 pymodel/saved_models 目录中，便于集中管理；

推理服务中，通过自定义的安全加载函数 safe_torch_load 读取权重文件，避免不同版本之间的兼容性问题，并在加载失败时提供清晰的错误提示；

FastAPI 服务在启动时调用模型构建和加载函数，将权重加载到模型实例中，并显式切换到评估模式；对于叶片存在性模型，还设计了基于文件修改时间的热更新机制，当检测到权重文件有更新时，自动重新加载模型，以便训练好的新模型能在不重启服务的情况下生效。

通过上述保存与加载策略，系统在训练与部署流程之间建立了可靠的衔接机制，方便模型的版本管理和在线更新。

## 4.5 模型推理服务设计与实现

### 4.5.1 FastAPI 推理服务结构

模型推理服务基于 FastAPI 框架实现，其入口文件集中在 pymodel 目录下的 API 脚本中。服务的基本结构包括：

应用实例创建：通过 FastAPI 类创建应用实例，设置服务标题和版本信息；

CORS 配置：为支持来自前端和后端的跨域请求，应用通过中间件允许指定源、方法和头，从而避免浏览器的跨域限制；

类别名初始化：在服务启动时调用辅助函数，从 JSON 文件或数据集自动生成并加载物种类别名列表和病害类别名列表，填充到全局配置中；

模型构建与权重加载：根据类别名列表构建物种和病害识别模型实例，从配置指定路径加载权重，并设置为评估模式；同时通过辅助模块根据叶片存在性权重文件的存在与否加载或跳过叶片模型；

变换流水线定义：通过 TorchVision 的 transforms.Compose 定义推理阶段统一的图像预处理流水线，包括 Resize、CenterCrop、ToTensor 和 Normalize 等操作；

健康检查接口 /health：返回模型是否成功加载、物种和病害类别数量以及当前运行设备等信息，为后端监控提供数据依据。

上述结构保证推理服务在启动时完成一次性的模型加载和预处理配置，避免在每次请求中重复构建模型，从而提升服务性能。

### 4.5.2 /predict 接口实现

/predict 接口是系统中完成图像推理的核心接口，其处理流程大致如下：

（1）文件上传与空文件校验。接口通过 FastAPI 的文件上传机制接收前端或后端转发的图片文件，首先读取字节内容并检查是否为空文件；若读取失败或文件内容为空，则返回 HTTP 400 错误，并给出相应提示。

（2）图像读取与预处理。接口使用 Pillow 将字节流解码为 RGB 图像，然后将图像传入预定义的变换流水线中执行 Resize、CenterCrop、ToTensor、Normalize 等操作，将图像转换为适合 MobileNetV2 输入的张量格式，并根据配置将张量移动到指定的设备（CPU/GPU）。

（3）阶段 1：调用叶片存在性模型进行背景拦截。若叶片存在性模型已成功加载，接口先调用该模型对输入图像进行二分类推理，得到“无叶片背景”概率和“有叶片”概率。根据配置的 LEAF_PRESENCE_NO_LEAF_THRESHOLD 和 LEAF_PRESENCE_THRESHOLD 等参数：

当“无叶片背景”概率大于等于严格阈值时，直接返回表示纯背景的判定结果，并在响应中标记拦截类型；

当概率介于普通阈值和严格阈值之间时，返回“疑似背景”结果，并提示用户重新拍摄更清晰的叶片图像；

仅当概率低于普通阈值时，才将图像送入物种与病害识别模型进行进一步推理。

（4）阶段 2：调用物种与病害模型进行双任务预测。在通过叶片存在性过滤后，接口将预处理后的图像张量分别送入物种识别模型和病害识别模型中，计算对应的 logits，随后通过 softmax 转换为概率分布，选取最大概率对应的类别作为主预测结果，并根据配置的 Top-K 值构造 Top-K 候选列表。

（5）结果封装与返回。接口将物种和病害预测结果（包括主预测类名、置信度和 Top-K 候选）封装为结构化的 JSON 对象，同时附带时间戳、当前识别阶段标记等信息，并在遇到异常时统一返回 HTTP 500 错误和简要错误描述。后端业务服务根据该 JSON 结果进行解析和进一步处理。

通过严格的输入校验、两阶段拦截和结构化输出设计，/predict 接口为业务系统提供了稳定、清晰且易于集成的推理能力。

### 4.5.3 与后端的集成

在后端 Spring Boot 应用中，通过配置项 ml.fastapi.url 指定了模型推理服务的地址（ http://127.0.0.1:8001）。后端在实现识别相关业务接口时，通过以下方式集成 FastAPI 服务：

（1）识别接口中调用 /predict。当后端收到来自前端的识别请求及图片文件后，会通过 HTTP 客户端将图片文件以表单数据方式转发到 ml.fastapi.url + "/predict" 路径，获取推理结果 JSON。若调用成功，则解析出物种、病害预测结果及置信度，并连同用户和图片信息一起存入数据库；若调用失败或超时，则返回友好错误提示。

（2）健康检查接口代理 /detect/health。为便于前端统一访问和状态展示，后端通常会实现一个代理接口（如 /detect/health），在该接口中调用 FastAPI 的 /health 端点，将返回的模型服务状态进行适度转换或封装，并将关键信息（如 fastapiAvailable 标志）返回给前端。前端在全局布局中周期性调用该代理接口，根据返回结果显示“模型服务在线/离线”等状态提示。

通过上述集成方式，后端业务服务与 FastAPI 模型服务在逻辑上保持解耦，在配置上通过 ml.fastapi.url 动态绑定，在运行时通过 REST 调用实现两者之间的协作。

## 4.6 业务系统详细实现

### 4.6.1 前端实现

前端实现集中在 bysj-mtj-web 子项目中，采用 Vue3 + TypeScript + Element Plus 技术栈构建单页应用。整体布局和导航设计集中在根组件 App.vue 中，主要特点包括：

统一的顶部导航栏，包含系统 Logo、主要功能路由入口（首页、识别、历史、知识库、技术指导、消息、购物车等）以及模型服务在线状态和用户信息展示；

通过导航菜单动态高亮当前路由，并根据用户角色（如管理员）切换不同的导航项组合；

右侧区域展示用户头像、昵称及身份标签（如普通用户、专家、管理员），未登录状态下提供登录入口。

在与后端接口交互方面，前端通过统一封装的 API 请求函数发起 HTTP 请求，处理响应数据，并在出现网络错误或业务错误时给出清晰的提示。例如：

在识别页面中，前端通过上传组件或拖拽区域收集待识别图片，调用后端的识别接口，并在收到结果后对页面进行状态更新；

在历史记录、知识库、技术指导、购物车和订单等页面中，前端通过异步请求加载列表数据和详情数据，并支持分页、筛选和跳转操作；

在消息页面中，前端通过 WebSocket 或长轮询方式保持与后端的连接，实现新消息的即时展示。

在登录状态和角色管理方面，前端通常将登录成功后返回的用户信息存储在浏览器的会话存储中，并在导航守卫中对即将进入的路由进行检查：若路由标记需要登录而当前会话中不存在用户信息，则重定向到登录页面；若访问后台管理页面但当前用户角色不是管理员，则跳转到普通用户首页，防止越权访问。

### 4.6.2 后端实现

后端实现集中在 springboot 子项目中，采用 Spring Boot 3 框架和典型的分层结构实现业务逻辑。整体上，后端通过一组 REST 控制器类对外暴露接口，内部则通过服务类和数据访问仓库类协同工作。

在接口设计方面，后端以资源为中心设计路径和动词，如用户相关接口负责注册、登录和个人信息维护；识别相关接口负责接收图片、调用 FastAPI 推理服务并持久化识别记录；知识与技术指导相关接口负责提供知识条目和文章的列表与详情；购物与订单相关接口负责商品查询、购物车操作和订单创建与查询等；

在数据访问层方面，通过 Spring Data JPA 定义实体类和仓库接口，实现对用户、识别记录、知识条目、技术指导文章、商品和订单等数据表的增删改查；

在消息与通知方面，引入 WebSocket 支持，为聊天和系统通知提供实时消息通道。服务端维护 WebSocket 连接会话，在业务逻辑触发新消息时主动推送给相关用户；

在配置管理方面，通过 application.properties 文件集中配置数据库连接信息、静态资源路径、上传文件大小限制、FastAPI 服务地址、数据集根目录、训练脚本工作目录、支付宝支付参数等关键配置项，便于在不同环境中进行快速调整。

通过上述实现，后端在保证业务逻辑完整性的同时，提供了良好的扩展性和可维护性。

4.6.3 数据库设计

数据库设计是系统实现中的重要部分，负责存储用户信息、识别记录、知识与技术指导内容、商品和订单等核心数据。系统使用 MySQL 作为关系型数据库，并辅以多份 SQL 初始化脚本完成数据表创建和部分基础数据插入。

在概念层面，系统的 E-R 图主要包含以下实体及其关系：

用户实体：存储用户账号、密码摘要、昵称、联系方式、角色类型（普通用户、专家、管理员）等信息；

识别记录实体：记录每一次识别请求的时间、所属用户、图片路径、物种预测结果、病害预测结果、置信度及模型服务状态等信息，与用户之间存在一对多关系；

病害知识实体：存储病害相关的基础知识，包括作物类型、病害名称、症状特征、防治措施等信息，与技术指导内容之间可通过作物或病害类别建立关联；

技术指导文章实体：记录技术指导文章的标题、内容、作者、发布时间等信息，与专家用户之间存在关联关系；

商品实体：存储农资商品的名称、类别、价格、库存、适用作物或病害、图片等信息；

订单及订单项实体：订单实体记录订单编号、用户、创建时间、总金额、状态等信息，订单项实体记录单个订单中每个商品的数量和单价；订单与用户之间是一对多关系，与订单项之间是一对多关系；

在实现层面，系统在 springboot 项目中提供了多份 SQL 脚本文件，如 init.sql、bhxx_table.sql 等，用于定义和初始化部分数据表结构和基础数据。通过结合 Spring Data JPA 实体类与这些表结构，后端可以以面向对象的方式对数据库进行操作，同时利用 JPA 提供的查询派生机制快速实现常见查询功能。

综上，本章从数据集与数据预处理、识别模型结构与训练实现、推理服务设计与实现以及业务系统前端、后端和数据库实现等方面，对本系统进行了详细设计与说明，为后续章节的测试与评价工作奠定了坚实基础。

# 第五章 系统测试与识别模型评估

系统测试是保证软件质量和可靠性的重要环节。本章在前几章需求分析和系统设计的基础上，从测试环境与工具、测试方法与策略、功能测试、识别模型测试与评估、性能测试以及测试结果分析与问题总结等方面，对本系统的测试工作进行说明。通过系统性的测试，可以验证各功能模块的正确性与稳定性，评估识别模型的效果，并对系统在一定负载下的性能表现进行分析，为后续优化提供依据。

## 5.1 测试环境与工具

为保证测试结果具有可参考性与可复现性，本系统的测试主要在与开发环境接近的软硬件环境下进行。整体环境配置可概括如下：

### 5.1.1 硬件环境

测试在一台普通 PC 上进行，硬件环境具有如下特点：

采用 x86_64 架构的多核 CPU，满足后端服务与模型推理的基本计算需求；

具有足够容量的内存，以支撑前端构建、后端运行、数据库服务和模型推理服务同时运行；

可选配独立 GPU（如常见的 NVIDIA GPU），在模型训练和推理阶段用于加速深度学习计算；

本地磁盘提供足够的存储空间，用于存放 PlantVillage 数据集、模型权重文件以及系统运行日志等。

在上述硬件条件下，系统能够顺利完成功能测试和中等规模的性能测试。对于更大规模的并发测试和模型训练任务，可在后续工作中迁移至更高配置服务器或云环境。

### 5.1.2 软件环境

软件环境方面，主要包括操作系统、运行时环境和数据库等：

•	操作系统：基于 Windows 平台的 64 位操作系统，用于运行前端构建工具、Java 后端、Python 模型服务和数据库；

•	Java 运行环境：安装 JDK 17，与 Spring Boot 项目的 pom.xml 中配置的 Java 版本保持一致；

•	Python 环境：安装 Python 3.x，结合 pymodel 目录下的 requirements.txt 安装 PyTorch、TorchVision、FastAPI、Uvicorn、scikit-learn、Matplotlib 等依赖库；

•	数据库系统：安装并配置 MySQL 8.x，结合后端 application.properties 中的连接参数创建并使用 bysj 数据库；

•	构建与运行工具：Node.js 与前端构建工具（如 Vite），用于构建和运行 Vue3 前端应用；Maven 用于管理 Spring Boot 项目的依赖和构建。

### 5.1.3 测试工具与辅助框架

在测试过程中，还使用了一些常用的辅助工具和测试框架：

•	接口测试工具：如 Postman 等，用于对后端 REST 接口（登录、识别、知识库、购物、订单等）进行功能验证和参数边界测试；

•	浏览器开发者工具：用于前端页面调试、网络请求监控和性能分析，帮助定位前端脚本错误和接口调用异常；

•	日志与监控工具：利用 Spring Boot 和 FastAPI 内建的日志输出，以及数据库日志等，观察系统在测试过程中的运行状态；

•	压力测试工具：可选使用 Apache JMeter 或类似工具，对识别接口和部分业务接口进行并发访问测试，分析响应时间和吞吐量表现。

通过上述软硬件环境和测试工具的配合，能够较为全面地完成系统功能、模型效果和性能方面的测试工作。

## 5.2 测试方法与测试策略

系统测试采用多种测试方法相结合的策略，从不同层次与角度对系统进行验证。

### 5.2.1 黑盒测试与白盒测试

在多数业务功能测试中，主要采用黑盒测试方法，即从用户视角出发，只关注输入与输出之间的关系，不关心内部实现细节。例如，登录功能测试关注在输入正确/错误账号密码时系统是否给予正确反馈；识别功能测试则关注上传图片后是否返回合理的识别结果和错误提示。

对于部分关键模块（如模型服务集成、支付配置读取、数据访问层映射等），则辅以白盒测试或代码走查的方式，检查逻辑分支覆盖情况和异常处理路径，确保在极端和异常条件下系统仍能按照预期行为运行，避免出现未捕获异常导致服务崩溃。

### 5.2.2 单元测试、集成测试与系统测试

从测试层次来看，本系统的测试可以划分为以下几个层次：

•	单元测试：针对某些具有独立逻辑的函数或方法（如数据预处理函数、结果格式化函数等）进行针对性测试，验证其在边界条件和异常输入下的行为是否正确；

•	集成测试：将前后端或后端与模型服务、数据库等多个组件组合起来进行联调，重点验证接口之间的调用是否正确，数据在不同模块间传递和转换是否准确；

•	系统测试：在系统整体搭建完成后，从用户操作流程角度验证系统是否满足第2章中提出的功能和非功能需求，包括多角色登录、识别业务、知识和技术指导、购物与订单、消息和通知、后台管理等完整业务场景。

5.2.3 回归测试策略

在开发迭代过程中，随着功能调整和 Bug 修复的不断进行，有可能引入新的问题或影响原有功能的稳定性。为此，系统测试中需要适时进行回归测试：

当对核心模块（如识别接口、用户认证、订单处理）进行修改时，应对相关功能的测试用例重新执行，验证新版本未破坏已有功能；

对于模型更新、配置调整或部署环境变化等情况，应重点关注识别结果和性能表现是否发生异常变化；

建议将部分关键测试用例固化下来，形成简化的回归测试集，在每次重要版本发布前统一执行，以提升版本发布的可靠性。

## 5.3 功能测试

功能测试主要围绕系统的各个业务模块展开，依据第2章功能需求分析中提出的模块划分，对登录、识别、历史记录、知识库、技术指导、购物、订单、支付、聊天和管理后台等主要功能进行逐项验证。

### 5.3.1 功能模块测试用例设计

在具体测试中，为每个功能模块设计若干测试用例，覆盖正常路径、边界情况和异常情况。主要测试内容包括：

登录与注册模块：测试正确账号密码登录、错误账号或密码登录、未填写必填字段、重复注册用户名等情况，验证系统对不同输入的响应是否符合预期；

植物病害识别模块：测试在登录状态下上传不同类型的图片（清晰叶片图像、模糊或部分遮挡图像、纯背景图像、非图像文件等），观察识别结果和错误提示是否合理；

历史记录模块：测试存在和不存在历史记录的情况，验证列表展示、详情查看以及根据时间等条件筛选的正确性；

知识库与技术指导模块：测试知识条目和技术指导文章列表加载、详情展示、分类筛选和搜索等功能，并验证与识别结果联动跳转是否正确；

购物与订单模块：测试商品列表与详情展示、加入购物车、购物车数量修改与删除、订单创建、订单状态查看等流程；

支付流程：在测试环境中模拟通过支付宝沙箱完成支付，验证支付请求发起、回调处理和订单状态更新是否正确；

聊天与消息模块：测试消息发送与接收、刷新页面后消息记录是否保留、系统通知的推送和展示情况；

管理后台模块：测试管理员登录后访问用户管理、知识管理、技术指导管理、商品与订单管理等页面的权限控制和基本操作，验证非管理员访问后台时是否被正确拦截。

### 5.3.2 测试用例表与执行结果记录

在实际测试过程中，可将上述各功能模块的测试用例整理为表格形式记录，包括用例编号、用例名称、前置条件、输入数据、操作步骤、预期结果和实际结果等字段。通过执行这些测试用例并记录结果，可以：

明确每一项功能是否通过测试，是否存在缺陷；

统计不通过用例的数量与类型，为后续 Bug 修复提供依据；

在多轮回归测试中对比前后执行结果，观察缺陷修复与功能稳定性的变化。

功能测试的总体目标是确保系统在典型和边界使用场景下行为符合需求说明，具备可用性和可靠性。

## 5.4 识别模型测试与评估

识别模型是本系统的技术核心，其效果直接影响病害诊断的准确性和实用价值。因此，有必要对模型进行专门的测试和评估，从多个指标和角度全面考察其表现。

### 5.4.1 测试集选择与划分说明

在模型训练阶段，PlantVillage 数据集已经按照训练集、验证集和测试集进行划分。模型评估阶段主要使用独立的测试集，对最终训练好的模型进行性能评估。为确保评估的客观性和公平性：

测试集中的样本不应参与训练与验证过程，避免数据泄漏；

测试集应覆盖所有主要物种和病害类别，保证类别分布相对均衡；

对于叶片存在性模型的评估，则需要在测试集中同时包含足够数量的背景图像和含叶片图像，以便对背景拦截策略进行有效检验。

必要时，可以在 PlantVillage 的原始数据基础上重新抽取一部分样本作为额外测试集，以验证模型在不同划分方式下的稳定性和鲁棒性。

### 5.4.2 分类性能指标

在对物种识别模型和病害识别模型进行评估时，常用的分类性能指标包括：

准确率（Accuracy）：测试集中被正确分类样本数占总样本数的比例，反映整体分类正确程度；

精确率（Precision）：在预测为某一类别的样本中，真正属于该类别的比例，衡量模型在该类别上的“查准”能力；

召回率（Recall）：在实际属于某一类别的样本中，被模型正确预测为该类别的比例，衡量模型在该类别上的“查全”能力；

F1 值（F1-score）：精确率和召回率的调和平均，用于在两者之间取得综合平衡；

Top-K 准确率：在考虑预测概率最高的 K 个候选类别时，是否包含真实类别的比例，在 Top-5 等指标下可以反映模型对“候选范围”的覆盖能力。

在实际评估中，可以针对每个类别单独计算精确率、召回率和 F1 值，再通过宏平均或加权平均得到整体指标。同时，也可以计算混淆矩阵，以可视化方式展示各类别之间的混淆情况，方便发现哪些物种或病害之间容易被模型混淆。

### 5.4.3 混淆矩阵与错误案例分析

混淆矩阵是分类任务评估中非常重要的工具，它以矩阵形式展示真实类别与预测类别之间的对应关系。通过观察混淆矩阵，可以：

识别出易混淆的类别对，例如叶片症状形态相似的两种病害，或健康叶片与轻度病害之间的混淆；

分析类别不平衡对模型的影响，观察样本数量较少的类别是否存在明显的召回率下降；

发现模型可能存在的系统性偏差，如对某些作物或病害类型整体